"use strict";(self.webpackChunkyolo_docs=self.webpackChunkyolo_docs||[]).push([[673],{3905:(e,t,n)=>{n.d(t,{Zo:()=>o,kt:()=>k});var r=n(67294);function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){p(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,r,p=function(e,t){if(null==e)return{};var n,r,p={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(p[n]=e[n]);return p}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(p[n]=e[n])}return p}var c=r.createContext({}),i=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},o=function(e){var t=i(e.components);return r.createElement(c.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,p=e.mdxType,s=e.originalType,c=e.parentName,o=a(e,["components","mdxType","originalType","parentName"]),u=i(n),d=p,k=u["".concat(c,".").concat(d)]||u[d]||m[d]||s;return n?r.createElement(k,l(l({ref:t},o),{},{components:n})):r.createElement(k,l({ref:t},o))}));function k(e,t){var n=arguments,p=t&&t.mdxType;if("string"==typeof e||p){var s=n.length,l=new Array(s);l[0]=d;var a={};for(var c in t)hasOwnProperty.call(t,c)&&(a[c]=t[c]);a.originalType=e,a[u]="string"==typeof e?e:p,l[1]=a;for(var i=2;i<s;i++)l[i]=n[i];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},38846:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>a,toc:()=>i});var r=n(87462),p=(n(67294),n(3905));const s={},l=void 0,a={unversionedId:"network/tcp\u9ad8\u5ef6\u65f6\u5206\u6790",id:"network/tcp\u9ad8\u5ef6\u65f6\u5206\u6790",title:"tcp\u9ad8\u5ef6\u65f6\u5206\u6790",description:"\u524d\u8a00",source:"@site/docs/network/tcp\u9ad8\u5ef6\u65f6\u5206\u6790.md",sourceDirName:"network",slug:"/network/tcp\u9ad8\u5ef6\u65f6\u5206\u6790",permalink:"/docs/network/tcp\u9ad8\u5ef6\u65f6\u5206\u6790",draft:!1,editUrl:"https://github.com/yoloz/yolo-docs/tree/docusaurus/docs/network/tcp\u9ad8\u5ef6\u65f6\u5206\u6790.md",tags:[],version:"current",lastUpdatedAt:1689663630,formattedLastUpdatedAt:"2023\u5e747\u670818\u65e5",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"tcp\u7f13\u51b2\u533a\u53c2\u6570",permalink:"/docs/network/tcp\u7f13\u51b2\u533a\u53c2\u6570"},next:{title:"\u4e86\u89e3tcp\u76d1\u542c",permalink:"/docs/network/\u4e86\u89e3tcp\u76d1\u542c"}},c={},i=[{value:"\u524d\u8a00",id:"\u524d\u8a00",level:2},{value:"TCP \u6027\u80fd\u548c\u53d1\u9001\u63a5\u6536 Buffer \u7684\u5173\u7cfb",id:"tcp-\u6027\u80fd\u548c\u53d1\u9001\u63a5\u6536-buffer-\u7684\u5173\u7cfb",level:2},{value:"\u63a5\u6536\u7a97\u53e3\u548c SO_RCVBUF \u7684\u5173\u7cfb",id:"\u63a5\u6536\u7a97\u53e3\u548c-so_rcvbuf-\u7684\u5173\u7cfb",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],o={toc:i},u="wrapper";function m(e){let{components:t,...s}=e;return(0,p.kt)(u,(0,r.Z)({},o,s,{components:t,mdxType:"MDXLayout"}),(0,p.kt)("h2",{id:"\u524d\u8a00"},"\u524d\u8a00"),(0,p.kt)("p",null,"\u672c\u6587\u5e0c\u671b\u89e3\u6790\u6e05\u695a\uff0c\u5f53\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u5199\u4e0b socket.setSendBufferSize \u548c sysctl \u770b\u5230\u7684 rmem/wmem \u7cfb\u7edf\u53c2\u6570\u4ee5\u53ca\u6700\u7ec8\u6211\u4eec\u5728 TCP \u5e38\u5e38\u8c08\u5230\u7684\u63a5\u6536\u53d1\u9001\u7a97\u53e3\u7684\u5173\u7cfb\uff0c\u4ee5\u53ca\u4ed6\u4eec\u600e\u6837\u5f71\u54cd TCP \u4f20\u8f93\u7684\u6027\u80fd\u3002"),(0,p.kt)("p",null,"\u5148\u660e\u786e\u4e00\u4e0b\uff1a\u6587\u7ae0\u6807\u9898\u4e2d\u6240\u8bf4\u7684 Buffer \u6307\u7684\u662f sysctl \u4e2d\u7684 rmem \u6216\u8005 wmem\uff0c\u5982\u679c\u662f\u4ee3\u7801\u4e2d\u6307\u5b9a\u7684\u8bdd\u5bf9\u5e94\u7740 SO_SNDBUF \u6216\u8005 SO_RCVBUF\uff0c\u4ece TCP \u7684\u6982\u5ff5\u6765\u770b\u5bf9\u5e94\u7740\u53d1\u9001\u7a97\u53e3\u6216\u8005\u63a5\u6536\u7a97\u53e3\u3002"),(0,p.kt)("h2",{id:"tcp-\u6027\u80fd\u548c\u53d1\u9001\u63a5\u6536-buffer-\u7684\u5173\u7cfb"},"TCP \u6027\u80fd\u548c\u53d1\u9001\u63a5\u6536 Buffer \u7684\u5173\u7cfb"),(0,p.kt)("p",null,"\u76f8\u5173\u53c2\u6570\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-bash"},'$sudo sysctl -a | egrep "rmem|wmem|adv_win|moderate"\nnet.core.rmem_default = 212992\nnet.core.rmem_max = 212992\nnet.core.wmem_default = 212992\nnet.core.wmem_max = 212992\nnet.ipv4.tcp_adv_win_scale = 1\nnet.ipv4.tcp_moderate_rcvbuf = 1\nnet.ipv4.tcp_rmem = 4096    87380   6291456\nnet.ipv4.tcp_wmem = 4096    16384   4194304\nnet.ipv4.udp_rmem_min = 4096\nnet.ipv4.udp_wmem_min = 4096\nvm.lowmem_reserve_ratio = 256   256 32\n')),(0,p.kt)("p",null,"\u5148\u4ece\u78b0\u5230\u7684\u4e00\u4e2a\u95ee\u9898\u770b\u8d77\uff1a"),(0,p.kt)("p",null,(0,p.kt)("em",{parentName:"p"},"\u5e94\u7528\u901a\u8fc7\u4e13\u7ebf\u4ece\u516c\u53f8\u8bbf\u95ee\u963f\u91cc\u4e91\u4e0a\u7684\u670d\u52a1\uff0c\u4e13\u7ebf 100M\uff0c\u65f6\u5ef6 20ms\uff0c\u4e00\u4e2a SQL \u67e5\u8be2\u4e86 22M \u6570\u636e\uff0c\u7ed3\u679c\u82b1\u4e86\u5927\u6982 25 \u79d2\uff0c\u8fd9\u592a\u6162\u4e86\uff0c\u4e0d\u6b63\u5e38\u3002\u5982\u679c\u901a\u8fc7\u4e91\u4e0a client \u8bbf\u95ee\u4e91\u4e0a\u670d\u52a1\u90a3\u4e48 1-2 \u79d2\u5c31\u8fd4\u56de\u4e86\uff08\u8bf4\u660e\u4e0d\u8de8\u7f51\u7edc\u670d\u52a1\u662f\u6b63\u5e38\u7684\uff09\u3002\u5982\u679c\u901a\u8fc7 http \u6216\u8005 scp \u4ece\u516c\u53f8\u5411\u4e91\u4e0a\u4f20\u8f93\u8fd9 22M \u7684\u6570\u636e\u5927\u6982\u4e24\u79d2\u949f\u4e5f\u4f20\u9001\u5b8c\u6bd5\u4e86\uff08\u8bf4\u660e\u7f51\u7edc\u5e26\u5bbd\u4e0d\u662f\u74f6\u9888\uff09\uff0c\u6240\u4ee5\u8fd9\u91cc\u95ee\u9898\u7684\u539f\u56e0\u57fa\u672c\u4e0a\u662f\u6211\u4eec\u7684\u670d\u52a1\u5728\u8fd9\u79cd\u7f51\u7edc\u6761\u4ef6\u4e0b\u6709\u6027\u80fd\u95ee\u9898\uff0c\u9700\u8981\u627e\u51fa\u4e3a\u4ec0\u4e48\u3002")),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u6293\u5305 tcpdump+wireshark")),(0,p.kt)("p",null,"\u8fd9\u4e2a\u67e5\u8be2\u7ed3\u679c 22M \u7684\u9700\u8981 25 \u79d2\uff0c\u5982\u4e0b\u56fe\uff08wireshark \u65f6\u5e8f\u56fe\uff09\uff0c\u6a2a\u8f74\u662f\u65f6\u95f4\uff0c\u7eb5\u8f74\u662f sequence number\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net1.png",src:n(64894).Z,width:"800",height:"401"})),(0,p.kt)("p",null,"\u7c97\u4e00\u770b\u6ca1\u5565\u95ee\u9898\uff0c\u56e0\u4e3a\u65f6\u95f4\u592a\u957f\u63a9\u76d6\u4e86\u95ee\u9898\u3002\u628a\u8fd9\u4e2a\u56fe\u5f62\u653e\u5927\uff0c\u5c31\u770b\u4e2d\u95f4 50ms \u5185\u7684\u4f20\u8f93\u60c5\u51b5\uff08\u6a2a\u8f74\u662f\u65f6\u95f4\uff0c\u7eb5\u8f74\u662f sequence number\uff0c\u4e00\u4e2a\u70b9\u4ee3\u8868\u4e00\u4e2a\u5305\uff09\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net2.png",src:n(40812).Z,width:"508",height:"591"})),(0,p.kt)("p",null,"\u6362\u4e2a\u89d2\u5ea6\uff0c\u770b\u770b\u7a97\u53e3\u5c3a\u5bf8\u56fe\u5f62\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net3.png",src:n(96967).Z,width:"800",height:"470"})),(0,p.kt)("p",null,"\u4ece bytes in flight \u4e5f\u5927\u81f4\u80fd\u7b97\u51fa\u6765\u603b\u7684\u4f20\u8f93\u65f6\u95f4 16K","*","1000/20=800Kb/\u79d2\n\u6211\u4eec\u7684\u5e94\u7528\u4f1a\u9ed8\u8ba4\u8bbe\u7f6e socketSendBuffer \u4e3a 16K\uff1a"),(0,p.kt)("blockquote",null,(0,p.kt)("p",{parentName:"blockquote"},"socket.setSendBufferSize(16","*","1024) //16K send buffer")),(0,p.kt)("p",null,"\u6765\u770b\u4e00\u4e0b tcp \u5305\u53d1\u9001\u6d41\u7a0b\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net4.png",src:n(97368).Z,width:"632",height:"590"})),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net5.png",src:n(28870).Z,width:"800",height:"736"})),(0,p.kt)("p",null,"\u5982\u679c sendbuffer \u4e0d\u591f\u5c31\u4f1a\u5361\u5728\u4e0a\u56fe\u4e2d\u7684\u7b2c\u4e00\u6b65 sk_stream_wait_memory\uff0c\u901a\u8fc7 systemtap \u811a\u672c\u53ef\u4ee5\u9a8c\u8bc1\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-bash"},'#!/usr/bin/stap\n# Simple probe to detect when a process is waiting for more socket send\n# buffer memory. Usually means the process is doing writes larger than the\n# socket send buffer size or there is a slow receiver at the other side.\n# Increasing the socket\'s send buffer size might help decrease application\n# latencies, but it might also make it worse, so buyer beware.\n\n# Typical output: timestamp in microseconds: procname(pid) event\n#\n# 1218230114875167: python(17631) blocked on full send buffer\n# 1218230114876196: python(17631) recovered from full send buffer\n# 1218230114876271: python(17631) blocked on full send buffer\n# 1218230114876479: python(17631) recovered from full send buffer\nprobe kernel.function("sk_stream_wait_memory")\n{\n    printf("%u: %s(%d) blocked on full send buffern",\n        gettimeofday_us(), execname(), pid())\n}\n\nprobe kernel.function("sk_stream_wait_memory").return\n{\n    printf("%u: %s(%d) recovered from full send buffern",\n        gettimeofday_us(), execname(), pid())\n}\n')),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u539f\u7406\u89e3\u6790")),(0,p.kt)("p",null,"\u5982\u679c tcp \u53d1\u9001 buffer \u4e5f\u5c31\u662f SO_SNDBUF \u53ea\u6709 16K \u7684\u8bdd\uff0c\u8fd9\u4e9b\u5305\u5f88\u5feb\u90fd\u53d1\u51fa\u53bb\u4e86\uff0c\u4f46\u662f\u8fd9 16K \u4e0d\u80fd\u7acb\u5373\u91ca\u653e\u51fa\u6765\u586b\u65b0\u7684\u5185\u5bb9\u8fdb\u53bb\uff0c\u56e0\u4e3a tcp \u8981\u4fdd\u8bc1\u53ef\u9760\uff0c\u4e07\u4e00\u4e2d\u95f4\u4e22\u5305\u4e86\u5462\u3002\u53ea\u6709\u7b49\u5230\u8fd9 16K \u4e2d\u7684\u67d0\u4e9b\u5305 ack \u4e86\uff0c\u624d\u4f1a\u586b\u5145\u4e00\u4e9b\u65b0\u5305\u8fdb\u6765\u7136\u540e\u7ee7\u7eed\u53d1\u51fa\u53bb\u3002\u7531\u4e8e\u8fd9\u91cc rt \u57fa\u672c\u662f 20ms\uff0c\u4e5f\u5c31\u662f 16K \u53d1\u9001\u5b8c\u6bd5\u540e\uff0c\u7b49\u4e86 20ms \u624d\u6536\u5230\u4e00\u4e9b ack\uff0c\u8fd9 20ms \u5e94\u7528\u3001\u5185\u6838\u4ec0\u4e48\u90fd\u4e0d\u80fd\u505a\uff0c\u6240\u4ee5\u5c31\u662f\u5982\u7b2c\u4e8c\u4e2a\u56fe\u4e2d\u7684\u5927\u6982 20ms \u7684\u7b49\u5f85\u5e73\u53f0\u3002"),(0,p.kt)("p",null,"sendbuffer \u76f8\u5f53\u4e8e\u53d1\u9001\u4ed3\u5e93\u7684\u5927\u5c0f\uff0c\u4ed3\u5e93\u7684\u8d27\u7269\u90fd\u53d1\u8d70\u540e\uff0c\u4e0d\u80fd\u7acb\u5373\u817e\u51fa\u6765\u53d1\u65b0\u7684\u8d27\u7269\uff0c\u800c\u662f\u8981\u7b49\u5bf9\u65b9\u786e\u8ba4\u6536\u5230\u4e86(ack)\u624d\u80fd\u817e\u51fa\u6765\u53d1\u65b0\u7684\u8d27\u7269\u3002 \u4f20\u8f93\u901f\u5ea6\u53d6\u51b3\u4e8e\u53d1\u9001\u4ed3\u5e93\uff08sendbuffer\uff09\u3001\u63a5\u6536\u4ed3\u5e93\uff08recvbuffer\uff09\u3001\u8def\u5bbd\uff08\u5e26\u5bbd\uff09\u7684\u5927\u5c0f\uff0c\u5982\u679c\u53d1\u9001\u4ed3\u5e93\uff08sendbuffer\uff09\u8db3\u591f\u5927\u4e86\u4e4b\u540e\u63a5\u4e0b\u6765\u7684\u74f6\u9888\u5c31\u662f\u9ad8\u901f\u516c\u8def\u4e86\uff08\u5e26\u5bbd\u3001\u62e5\u585e\u7a97\u53e3\uff09\u3002"),(0,p.kt)("p",null,"\u5982\u679c\u662f UDP\uff0c\u5c31\u6ca1\u6709\u53ef\u9760\u7684\u6982\u5ff5\uff0c\u6709\u6570\u636e\u7edf\u7edf\u53d1\u51fa\u53bb\uff0c\u6839\u672c\u4e0d\u5173\u5fc3\u5bf9\u65b9\u662f\u5426\u6536\u5230\uff0c\u4e5f\u5c31\u4e0d\u9700\u8981 ack \u548c\u8fd9\u4e2a\u53d1\u9001 buffer \u4e86\u3002"),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u51e0\u4e2a\u53d1\u9001 buffer \u76f8\u5173\u7684\u5185\u6838\u53c2\u6570")),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre"},"vm.lowmem_reserve_ratio = 256   256     32\nnet.core.wmem_max = 1048576\nnet.core.wmem_default = 124928\nnet.ipv4.tcp_wmem = 4096        16384   4194304\nnet.ipv4.udp_wmem_min = 4096\n")),(0,p.kt)("p",null,"net.ipv4.tcp_wmem \u9ed8\u8ba4\u5c31\u662f 16K\uff0c\u800c\u4e14\u662f\u80fd\u591f\u52a8\u6001\u8c03\u6574\u7684\uff0c\u53ea\u4e0d\u8fc7\u6211\u4eec\u4ee3\u7801\u4e2d\u8fd9\u5757\u7684\u53c2\u6570\u662f\u5f88\u591a\u5e74\u524d\u4ece Cobra \u4e2d\u7ee7\u627f\u8fc7\u6765\u7684\uff0c\u521d\u59cb\u6307\u5b9a\u4e86 sendbuffer \u7684\u5927\u5c0f\u3002\u4ee3\u7801\u4e2d\u8bbe\u7f6e\u4e86\u8fd9\u4e2a\u53c2\u6570\u540e\u5c31\u5173\u95ed\u4e86\u5185\u6838\u7684\u52a8\u6001\u8c03\u6574\u529f\u80fd\uff0c\u4f46\u662f\u80fd\u770b\u5230 http \u6216\u8005 scp \u90fd\u5f88\u5feb\uff0c\u56e0\u4e3a\u4ed6\u4eec\u7684 send buffer \u662f\u52a8\u6001\u8c03\u6574\u7684\uff0c\u6240\u4ee5\u5f88\u5feb\u3002"),(0,p.kt)("p",null,"\u63a5\u6536 buffer \u662f\u6709\u5f00\u5173\u53ef\u4ee5\u52a8\u6001\u63a7\u5236\u7684\uff0c\u53d1\u9001 buffer \u6ca1\u6709\u5f00\u5173\u9ed8\u8ba4\u5c31\u662f\u5f00\u542f\uff0c\u5173\u95ed\u53ea\u80fd\u5728\u4ee3\u7801\u5c42\u9762\u6765\u63a7\u5236\uff1a",(0,p.kt)("inlineCode",{parentName:"p"},"net.ipv4.tcp_moderate_rcvbuf")),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u4f18\u5316")),(0,p.kt)("p",null,"\u8c03\u6574 socketSendBuffer \u5230 256K\uff0c\u67e5\u8be2\u65f6\u95f4\u4ece 25 \u79d2\u4e0b\u964d\u5230\u4e86 4 \u79d2\u591a\uff0c\u4f46\u662f\u6bd4\u7406\u8bba\u5e26\u5bbd\u6240\u9700\u8981\u7684\u65f6\u95f4\u7565\u9ad8\u3002"),(0,p.kt)("p",null,"\u7ee7\u7eed\u67e5\u770b\u7cfb\u7edf net.core.wmem_max \u53c2\u6570\u9ed8\u8ba4\u6700\u5927\u662f 130K\uff0c\u6240\u4ee5\u5373\u4f7f\u6211\u4eec\u4ee3\u7801\u4e2d\u8bbe\u7f6e 256K \u5b9e\u9645\u4f7f\u7528\u7684\u4e5f\u662f 130K\uff0c\u8c03\u5927\u8fd9\u4e2a\u7cfb\u7edf\u53c2\u6570\u540e\u6574\u4e2a\u7f51\u7edc\u4f20\u8f93\u65f6\u95f4\u5927\u6982 2 \u79d2(\u8ddf 100M \u5e26\u5bbd\u5339\u914d\u4e86\uff0cscp \u4f20\u8f93 22M \u6570\u636e\u4e5f\u8981 2 \u79d2\uff09\uff0c\u6574\u4f53\u67e5\u8be2\u65f6\u95f4 2.8 \u79d2\u3002\u6d4b\u8bd5\u7528\u7684 mysql client \u77ed\u8fde\u63a5\uff0c\u5982\u679c\u4ee3\u7801\u4e2d\u7684\u662f\u957f\u8fde\u63a5\u7684\u8bdd\u4f1a\u5757 300-400ms\uff08\u6d88\u6389\u4e86\u6162\u542f\u52a8\u9636\u6bb5\uff09\uff0c\u8fd9\u57fa\u672c\u4e0a\u662f\u7406\u8bba\u4e0a\u6700\u5feb\u901f\u5ea6\u4e86\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net6.png",src:n(75482).Z,width:"800",height:"490"})),(0,p.kt)("p",null,"\u5982\u679c\u6307\u5b9a\u4e86 tcp_wmem\uff0c\u5219 net.core.wmem_default \u88ab tcp_wmem \u7684\u8986\u76d6\u3002send Buffer \u5728 tcp_wmem \u7684\u6700\u5c0f\u503c\u548c\u6700\u5927\u503c\u4e4b\u95f4\u81ea\u52a8\u8c03\u6574\u3002\u5982\u679c\u8c03\u7528 setsockopt()\u8bbe\u7f6e\u4e86 socket \u9009\u9879 SO_SNDBUF\uff0c\u5c06\u5173\u95ed\u53d1\u9001\u7aef\u7f13\u51b2\u7684\u81ea\u52a8\u8c03\u8282\u673a\u5236\uff0ctcp_wmem \u5c06\u88ab\u5ffd\u7565\uff0cSO_SNDBUF \u7684\u6700\u5927\u503c\u7531 net.core.wmem_max \u9650\u5236\u3002"),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"BDP \u5e26\u5bbd\u65f6\u5ef6\u79ef")),(0,p.kt)("p",null,"BDP=rtt","*","(\u5e26\u5bbd/8)"),(0,p.kt)("p",null,"\u8fd9\u4e2a buffer \u8c03\u5230 1M \u6d4b\u8bd5\u6ca1\u6709\u5e2e\u52a9\uff0c\u4ece\u7406\u8bba\u8ba1\u7b97 BDP\uff08\u5e26\u5bbd\u65f6\u5ef6\u79ef\uff09 0.02 \u79d2","*","(100MB/8)=250Kb \u6240\u4ee5 SO_SNDBUF \u4e3a 256Kb \u7684\u65f6\u5019\u57fa\u672c\u80fd\u8dd1\u6ee1\u5e26\u5bbd\u4e86\uff0c\u518d\u5927\u5b9e\u9645\u610f\u4e49\u4e5f\u4e0d\u5927\u4e86\u3002\u4e5f\u5c31\u662f\u524d\u9762\u6240\u8bf4\u7684\u4ed3\u5e93\u8db3\u591f\u540e\u74f6\u9888\u5728\u5e26\u5bbd\u4e0a\u4e86\u3002"),(0,p.kt)("p",null,"\u56e0\u4e3a BDP \u662f 250K\uff0c\u4e5f\u5c31\u662f\u62e5\u585e\u7a97\u53e3\uff08\u5e26\u5bbd\u3001\u63a5\u6536\u7a97\u53e3\u548c rt \u51b3\u5b9a\u7684\uff09\u5373\u5c06\u6210\u4e3a\u65b0\u7684\u74f6\u9888\uff0c\u6240\u4ee5\u8c03\u5927 buffer \u6ca1\u610f\u4e49\u4e86\u3002"),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u7528 tc \u6784\u9020\u5ef6\u65f6\u548c\u5e26\u5bbd\u9650\u5236\u7684\u6a21\u62df\u91cd\u73b0\u73af\u5883")),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre"},"sudo tc qdisc del dev eth0 root netem delay 20ms\nsudo tc qdisc add dev eth0 root tbf rate 500kbit latency 50ms burst 15kb\n")),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u8fd9\u4e2a\u6848\u4f8b\u5173\u4e8e wmem \u7684\u7ed3\u8bba")),(0,p.kt)("p",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b Linux \u7cfb\u7edf\u4f1a\u81ea\u52a8\u8c03\u6574\u8fd9\u4e2a buffer\uff08net.ipv4.tcp_wmem\uff09, \u4e5f\u5c31\u662f\u4e0d\u63a8\u8350\u7a0b\u5e8f\u4e2d\u4e3b\u52a8\u53bb\u8bbe\u7f6e SO_SNDBUF\uff0c\u9664\u975e\u660e\u786e\u77e5\u9053\u8bbe\u7f6e\u7684\u503c\u662f\u6700\u4f18\u7684\u3002"),(0,p.kt)("p",null,"\u4ece\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u6709\u4e9b\u7406\u8bba\u77e5\u8bc6\u70b9\u867d\u7136\u6211\u4eec\u77e5\u9053\uff0c\u4f46\u662f\u5728\u5b9e\u8df5\u4e2d\u5f88\u96be\u8054\u7cfb\u8d77\u6765\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684\u65e0\u6cd5\u5b66\u4ee5\u81f4\u7528\uff0c\u6700\u5f00\u59cb\u770b\u5230\u6293\u5305\u7ed3\u679c\u7684\u65f6\u5019\u6bd4\u8f83\u6000\u7591\u53d1\u9001\u3001\u63a5\u6536\u7a97\u53e3\u4e4b\u7c7b\u7684\uff0c\u6ca1\u6709\u76f4\u63a5\u60f3\u5230 send buffer \u4e0a\uff0c\u7406\u8bba\u8ddf\u5b9e\u8df5\u7684\u9e3f\u6c9f\u3002"),(0,p.kt)("p",null,"\u8bf4\u5b8c\u53d1\u9001 Buffer(wmem)\u63a5\u4e0b\u6765\u6211\u4eec\u63a5\u7740\u4e00\u770b\u770b\u63a5\u6536 buffer(rmem)\u548c\u63a5\u6536\u7a97\u53e3\u7684\u60c5\u51b5"),(0,p.kt)("p",null,"\u7528\u8fd9\u6837\u4e00\u4e2a\u6848\u4f8b\u4e0b\u6765\u9a8c\u8bc1\u63a5\u6536\u7a97\u53e3\u7684\u4f5c\u7528\uff1a"),(0,p.kt)("p",null,(0,p.kt)("em",{parentName:"p"},"\u6709\u4e00\u4e2a batch insert \u8bed\u53e5\uff0c\u6574\u4e2a\u4e00\u6b21\u8981\u63d2\u5165 5532 \u6761\u8bb0\u5f55\uff0c\u6240\u6709\u8bb0\u5f55\u5927\u5c0f\u603b\u5171\u662f 376K\u3002\nSO_RCVBUF \u5f88\u5c0f\u7684\u65f6\u5019\u5e76\u4e14 rtt \u5f88\u5927\u5bf9\u6027\u80fd\u7684\u5f71\u54cd")),(0,p.kt)("p",null,"\u5982\u679c rtt \u662f 40ms\uff0c\u603b\u5171\u9700\u8981 5-6 \u79d2\u949f\uff1a"),(0,p.kt)("p",null,"\u57fa\u672c\u53ef\u4ee5\u770b\u5230 server \u4e00\u65e6\u7a7a\u51fa\u6765\u70b9\u7a97\u53e3\uff0cclient \u9a6c\u4e0a\u5c31\u53d1\u9001\u6570\u636e\uff0c\u7531\u4e8e\u8fd9\u70b9\u7a97\u53e3\u592a\u5c0f\uff0crtt \u662f 40ms\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a rtt \u624d\u80fd\u4f20 3456 \u5b57\u8282\u7684\u6570\u636e\uff0c\u6574\u4e2a\u5e26\u5bbd\u624d 80-90K\uff0c\u5b8c\u5168\u6ca1\u8dd1\u6ee1\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net7.png",src:n(23422).Z,width:"435",height:"526"})),(0,p.kt)("p",null,"\u6bd4\u8f83\u660e\u663e\u95f4\u9694 40ms \u4e00\u4e2a\u7b49\u5f85\u53f0\u9636\uff0c\u53f0\u9636\u4e4b\u95f4\u4e24\u4e2a\u5305\u5927\u6982 3K \u6570\u636e\uff0c\u603b\u7684\u4f20\u8f93\u6548\u7387\u5982\u4e0b\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net8.png",src:n(34159).Z,width:"389",height:"593"})),(0,p.kt)("p",null,"\u659c\u7ebf\u8d8a\u9661\u8868\u793a\u901f\u5ea6\u8d8a\u5feb\uff0c\u4ece\u4e0a\u56fe\u770b\u6574\u4f53 SQL \u4e0a\u4f20\u82b1\u4e86 5.5 \u79d2\uff0c\u6267\u884c 0.5 \u79d2\u3002"),(0,p.kt)("p",null,"\u6b64\u65f6\u5bf9\u5e94\u7684\u7a97\u53e3\u5c3a\u5bf8\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net9.png",src:n(39859).Z,width:"800",height:"506"})),(0,p.kt)("p",null,"\u7a97\u53e3\u7531\u6700\u5f00\u59cb 28K(20 \u4e2a 1448\uff09\u5f88\u5feb\u964d\u5230\u4e86\u4e0d\u5230 4K \u7684\u6837\u5b50\uff0c\u7136\u540e\u57fa\u672c\u6e38\u8d70\u5728\u5373\u5c06\u6ee1\u7684\u8fb9\u7f18\uff0c\u867d\u7136\u8bfb\u53d6\u6162\uff0c\u5e78\u597d rtt \u4e5f\u5927\uff0c\u5bfc\u81f4\u6700\u7ec8\u4e5f\u6ca1\u6709\u6ee1\u3002\uff08\u8fd9\u4e2a\u662f 3.1 \u7684 Linux\uff0c\u5e94\u7528 SO_RCVBUF \u8bbe\u7f6e\u7684\u662f 8K\uff0c\u7528\u4e00\u534a\u6765\u505a\u63a5\u6536\u7a97\u53e3\uff09\u3002"),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"SO_RCVBUF \u5f88\u5c0f\u7684\u65f6\u5019\u5e76\u4e14 rtt \u5f88\u5c0f\u65f6\u5bf9\u6027\u80fd\u7684\u5f71\u54cd")),(0,p.kt)("p",null,"\u5982\u679c\u540c\u6837\u7684\u8bed\u53e5\u5728 rtt \u662f 0.1ms \u7684\u8bdd\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net10.png",src:n(22485).Z,width:"800",height:"374"})),(0,p.kt)("p",null,"\u867d\u7136\u660e\u663e\u770b\u5230\u63a5\u6536\u7a97\u53e3\u7ecf\u5e38\u8dd1\u6ee1\uff0c\u4f46\u662f\u56e0\u4e3a rtt \u5f88\u5c0f\uff0c\u4e00\u65e6\u7a97\u53e3\u7a7a\u51fa\u6765\u5f88\u5feb\u5c31\u901a\u77e5\u5230\u5bf9\u65b9\u4e86\uff0c\u6240\u4ee5\u6574\u4e2a\u8fc7\u5c0f\u7684\u63a5\u6536\u7a97\u53e3\u4e5f\u6ca1\u600e\u4e48\u5f71\u54cd\u5230\u6574\u4f53\u6027\u80fd\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net11.png",src:n(26806).Z,width:"426",height:"800"})),(0,p.kt)("p",null,"\u5982\u4e0a\u56fe 11.4 \u79d2\u6574\u4e2a SQL \u5f00\u59cb\uff0c\u5230 11.41 \u79d2 SQL \u4e0a\u4f20\u5b8c\u6bd5\uff0c11.89 \u79d2\u6267\u884c\u5b8c\u6bd5\uff08\u6267\u884c\u82b1\u4e86 0.5 \u79d2\uff09\uff0c\u4e0a\u4f20\u53ea\u82b1\u4e86 0.01 \u79d2\uff0c\u63a5\u6536\u7a97\u53e3\u60c5\u51b5\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net12.png",src:n(91874).Z,width:"474",height:"795"})),(0,p.kt)("p",null,"\u5982\u56fe\uff0c\u63a5\u6536\u7a97\u53e3\u7531\u6700\u5f00\u59cb\u7684 28K \u964d\u4e0b\u6765\uff0c\u7136\u540e\u4e00\u76f4\u5728 5880 \u548c\u6ee1\u4e86\u4e4b\u95f4\u8df3\u52a8\uff1a"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net13.png",src:n(70239).Z,width:"703",height:"800"})),(0,p.kt)("p",null,"\u4ece\u8fd9\u91cc\u53ef\u4ee5\u5f97\u51fa\u7ed3\u8bba\uff0c\u63a5\u6536\u7a97\u53e3\u7684\u5927\u5c0f\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\uff0crtt \u8d8a\u5927\u5f71\u54cd\u8d8a\u660e\u663e\uff0c\u5f53\u7136\u8fd9\u91cc\u8fd8\u9700\u8981\u5e94\u7528\u7a0b\u5e8f\u914d\u5408\uff0c\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u4e00\u76f4\u4e0d\u8bfb\u8d70\u6570\u636e\u5373\u4f7f\u63a5\u6536\u7a97\u53e3\u518d\u5927\u4e5f\u4f1a\u5806\u6ee1\u7684\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net14.png",src:n(30983).Z,width:"800",height:"493"})),(0,p.kt)("p",null,"\u4e0a\u56fe\u4e2d\u7ea2\u8272\u5e73\u53f0\u90e8\u5206\uff0c\u505c\u987f\u4e86\u5927\u6982 6 \u79d2\u949f\u6ca1\u6709\u53d1\u4efb\u4f55\u6709\u5185\u5bb9\u7684\u6570\u636e\u5305\uff0c\u8fd9 6 \u79d2\u949f\u5177\u4f53\u5728\u505a\u4ec0\u4e48\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u65f6\u5019\u63a5\u6536\u65b9\u7684 TCP Window Full\uff0c\u540c\u65f6\u4e5f\u80fd\u770b\u5230\u63a5\u6536\u65b9\uff083306 \u7aef\u53e3\uff09\u7684 TCP Window Size \u662f 8192\uff088K\uff09\uff0c\u53d1\u9001\u65b9\uff0827545 \u7aef\u53e3\uff09\u662f 20480\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net15.png",src:n(76541).Z,width:"800",height:"430"})),(0,p.kt)("p",null,"\u8fd9\u4e2a\u72b6\u51b5\u8ddf\u524d\u9762\u63cf\u8ff0\u7684 recv buffer \u592a\u5c0f\u4e0d\u4e00\u6837\uff0c8K \u662f\u5f88\u5c0f\uff0c\u4f46\u662f\u56e0\u4e3a rtt \u4e5f\u5f88\u5c0f\uff0c\u6240\u4ee5 server \u603b\u662f\u80fd\u5f88\u5feb\u5c31 ack \u6536\u5230\u4e86\uff0c\u63a5\u6536\u7a97\u53e3\u4e5f\u4e00\u76f4\u4e0d\u5bb9\u6613\u8fbe\u5230 full \u72b6\u6001\uff0c\u4f46\u662f\u4e00\u65e6\u63a5\u6536\u7a97\u53e3\u8fbe\u5230\u4e86 full \u72b6\u6001\uff0c\u5c45\u7136\u9700\u8981\u60ca\u4eba\u7684 6 \u79d2\u949f\u624d\u80fd\u6062\u590d\uff0c\u8fd9\u7b49\u5f85\u7684\u65f6\u95f4\u6709\u70b9\u592a\u957f\u4e86\u3002\u8fd9\u91cc\u5e94\u8be5\u662f\u5e94\u7528\u8bfb\u53d6\u6570\u636e\u592a\u6162\u5bfc\u81f4\u4e86\u8017\u65f6 6 \u79d2\u624d\u6062\u590d\uff0c\u6240\u4ee5\u6700\u7ec8\u8fd9\u4e2a\u8bf7\u6c42\u6267\u884c\u4f1a\u975e\u5e38\u975e\u5e38\u6162\uff08\u65f6\u95f4\u4e3b\u8981\u8017\u5728\u4e86\u4e0a\u4f20 SQL \u800c\u4e0d\u662f\u6267\u884c SQL\uff09\u3002"),(0,p.kt)("p",null,"\u5b9e\u9645\u539f\u56e0\u4e0d\u77e5\u9053\uff0c\u4ece\u8bfb\u53d6 TCP \u6570\u636e\u7684\u903b\u8f91\u6765\u770b\u8fd9\u91cc\u6ca1\u6709\u660e\u663e\u7684 block\uff0c\u53ef\u80fd\u7684\u539f\u56e0\uff1a"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"request \u7684 SQL \u592a\u5927\uff0cServer\uff083306 \u7aef\u53e3\u4e0a\u7684\u670d\u52a1\uff09\u4ece TCP \u8bfb\u53d6 SQL \u9700\u8981\u653e\u5230\u4e00\u5757\u5206\u914d\u597d\u7684\u5185\u5b58\uff0c\u5185\u5b58\u4e0d\u591f\u7684\u65f6\u5019\u9700\u8981\u6269\u5bb9\uff0c\u6269\u5bb9\u6709\u53ef\u80fd\u89e6\u53d1 fgc\uff0c\u4ece\u56fe\u5f62\u6765\u770b\uff0c\u7b2c\u4e00\u6b21\u6ee1\u5c31\u5361\u987f\u4e86\uff0c\u800c\u4e14\u6bcf\u6b21\u6ee1\u90fd\u5361\u987f\uff0c\u4e0d\u50cf\u662f\u8fd9\u4e2a\u539f\u56e0"),(0,p.kt)("li",{parentName:"ul"},"request \u8bf7\u6c42\u4e00\u6b21\u53d1\u8fc7\u6765\u7684\u662f\u591a\u4e2a SQL\uff0c\u5e94\u7528\u8bfb\u53d6 SQL \u540e\uff0c\u5c06 SQL \u5206\u6210\u591a\u4e2a\uff0c\u7136\u540e\u5148\u6267\u884c\u7b2c\u4e00\u4e2a\uff0c\u7b2c\u4e00\u4e2a\u6267\u884c\u5b8c\u540e\u8fd4\u56de response\uff0c\u518d\u8bfb\u53d6\u7b2c\u4e8c\u4e2a\u3002\u56fe\u5f62\u4e2d\u5361\u987f\u524d\u6ca1\u6709 response \u8fd4\u56de\uff0c\u6240\u4ee5\u4e5f\u4e0d\u662f\u8fd9\u4e2a\u539f\u56e0\u3002"),(0,p.kt)("li",{parentName:"ul"},"\u2026\u2026\u5176\u5b83\u672a\u77e5\u539f\u56e0")),(0,p.kt)("p",null,(0,p.kt)("strong",{parentName:"p"},"\u63a5\u6536\u65b9\u4e0d\u8bfb\u53d6\u6570\u636e\u5bfc\u81f4\u7684\u63a5\u6536\u7a97\u53e3\u6ee1\u540c\u65f6\u6709\u4e22\u5305\u53d1\u751f")),(0,p.kt)("p",null,"\u670d\u52a1\u7aef\u8fd4\u56de\u6570\u636e\u5230 client \u7aef\uff0cTCP \u534f\u8bae\u6808 ack \u8fd9\u4e9b\u5305\uff0c\u4f46\u662f\u5e94\u7528\u5c42\u6ca1\u8bfb\u8d70\u5305\uff0c\u8fd9\u4e2a\u65f6\u5019 SO_RCVBUF \u5806\u79ef\u6ee1\uff0cclient \u7684 TCP \u534f\u8bae\u6808\u53d1\u9001 ZeroWindow \u6807\u5fd7\u7ed9\u670d\u52a1\u7aef\u3002\u4e5f\u5c31\u662f\u63a5\u6536\u7aef\u7684 buffer \u5806\u6ee1\u4e86\uff08\u4f46\u662f\u670d\u52a1\u7aef\u8fd9\u4e2a\u65f6\u5019\u770b\u5230\u7684 bytes in fly \u662f 0\uff0c\u56e0\u4e3a\u90fd ack \u4e86\uff09\uff0c\u8fd9\u65f6\u670d\u52a1\u7aef\u4e0d\u80fd\u7ee7\u7eed\u53d1\u6570\u636e\uff0c\u8981\u7b49 ZeroWindow \u6062\u590d\u3002"),(0,p.kt)("p",null,"\u90a3\u4e48\u63a5\u6536\u7aef\u4e0a\u5c42\u5e94\u7528\u4e0d\u8bfb\u8d70\u5305\u53ef\u80fd\u7684\u539f\u56e0\uff1a"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"\u5e94\u7528\u4ee3\u7801\u5361\u987f\u3001GC \u7b49\u7b49")),(0,p.kt)("p",null,"\u5e94\u7528\u4ee3\u7801\u903b\u8f91\u4e0a\u5728\u505a\u5176\u5b83\u4e8b\u60c5\uff08\u6bd4\u5982 Server \u5c06 SQL \u5206\u7247\u5230\u591a\u4e2a DB \u4e0a\uff0cServer \u5148\u8bfb\u53d6\u7b2c\u4e00\u4e2a\u5206\u7247\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5206\u7247\u6570\u636e\u5f88\u5927\u5f88\u5927\uff0c\u5904\u7406\u4e5f\u6162\uff0c\u90a3\u4e48\u7b2c\u4e8c\u4e2a\u5206\u7247\u6570\u636e\u90fd\u8fd4\u56de\u5230\u4e86 TCP buffer\uff0c\u4e5f\u6ca1\u53bb\u8bfb\u53d6\u5176\u5b83\u5206\u7247\u7684\u7ed3\u679c\u96c6\uff0c\u76f4\u5230\u7b2c\u4e00\u4e2a\u5206\u7247\u8bfb\u53d6\u5b8c\u6bd5\u3002\u5982\u679c SQL \u5e26\u6392\u5e8f\uff0c\u90a3\u4e48 Server\u3002"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"\u4f1a\u8f6e\u8be2\u8bfb\u53d6\u591a\u4e2a\u5206\u7247\uff0c\u9020\u6210\u8fd9\u79cd\u5361\u987f\u7684\u6982\u7387\u5c0f\u4e86\u5f88\u591a")),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net16.png",src:n(59292).Z,width:"800",height:"601"})),(0,p.kt)("p",null,"\u4e0a\u56fe\u8fd9\u4e2a\u6d41\u56e0\u4e3a\u5e94\u7528\u5c42\u4e0d\u8bfb\u53d6 TCP \u6570\u636e\uff0c\u5bfc\u81f4 TCP \u63a5\u6536 Buffer \u6ee1\uff0c\u8fdb\u800c\u63a5\u6536\u7a97\u53e3\u4e3a 0\uff0cserver \u7aef\u4e0d\u80fd\u518d\u53d1\u9001\u6570\u636e\u800c\u5361\u4f4f\uff0c\u4f46\u662f ZeroWindow \u7684\u63a2\u6d4b\u5305\uff0cclient \u90fd\u6709\u6b63\u5e38\u56de\u590d\uff0c\u6240\u4ee5 1903 \u79d2\u4e4b\u540e\u63a5\u6536\u65b9\u7a97\u53e3\u4e0d\u4e3a 0 \u540e\uff08window update\uff09\u4f20\u8f93\u6062\u590d\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net17.png",src:n(84013).Z,width:"800",height:"284"})),(0,p.kt)("p",null,"\u8fd9\u4e2a\u622a\u56fe\u548c\u524d\u4e00\u4e2a\u7c7b\u4f3c\uff0c\u662f\u5728 Server \u4e0a(3003 \u7aef\u53e3)\u6293\u5230\u7684\u5305\uff0c\u4e0d\u540c\u7684\u662f\u63a5\u6536\u7a97\u53e3\u4e3a 0 \u540e\uff0cserver \u7aef\u591a\u6b21\u63a2\u6d4b\uff08Server \u4e0a\u6293\u5305\u80fd\u770b\u5230\uff09\uff0c\u4f46\u662f client \u7aef\u6ca1\u6709\u56de\u590d ZeroWindow\uff08\u4e5f\u6709\u53ef\u80fd\u662f\u56de\u590d\u4e86\uff0c\u4f46\u662f\u4e2d\u95f4\u73af\u8282\u628a ack \u5305\u4e22\u4e86,\u6216\u8005\u8fd9\u4e2a\u63a2\u6d4b\u5305 client \u6ca1\u6536\u5230\uff09\uff0c\u9020\u6210 server \u7aef\u8ba4\u4e3a client \u6b7b\u4e86\u3001\u4e0d\u53ef\u8fbe\u4e4b\u7c7b\uff0c\u8fdb\u800c\u53cd\u590d\u91cd\u4f20\uff0c\u91cd\u4f20\u8d85\u8fc7 15 \u6b21\u4e4b\u540e\uff0cserver \u7aef\u8ba4\u4e3a\u8fd9\u4e2a\u8fde\u63a5\u6b7b\u4e86\uff0c\u7c97\u66b4\u5355\u65b9\u9762\u65ad\u5f00\uff08\u6ca1\u6709 reset \u548c fin,\u56e0\u4e3a\u6ca1\u5fc5\u8981\uff0cserver \u8ba4\u4e3a\u7f51\u7edc\u8fde\u901a\u6027\u51fa\u4e86\u95ee\u9898\uff09\u3002"),(0,p.kt)("p",null,"\u7b49\u5230 1800 \u79d2\u540e\uff0cclient \u7684\u63a5\u6536\u7a97\u53e3\u6062\u590d\u4e86\uff0c\u53d1\u4e2a window update \u7ed9 server\uff0c\u8fd9\u4e2a\u65f6\u5019 server \u8ba4\u4e3a\u8fd9\u4e2a\u8fde\u63a5\u5df2\u7ecf\u65ad\u5f00\u4e86\uff0c\u53ea\u80fd\u56de\u590d reset\u3002"),(0,p.kt)("p",null,"\u7f51\u7edc\u4e0d\u901a\uff0c\u91cd\u4f20\u8d85\u8fc7\u4e00\u5b9a\u7684\u65f6\u95f4\uff08tcp_retries2)\u7136\u540e\u65ad\u5f00\u8fd9\u4e2a\u8fde\u63a5\u662f\u6b63\u5e38\u7684\uff0c\u8fd9\u91cc\u7684\u95ee\u9898\u662f\uff1a"),(0,p.kt)("p",null,"\u4e3a\u4ec0\u4e48\u8fd9\u79cd\u573a\u666f\u4e0b\u4e22\u5305\u4e86\uff0c\u800c\u4e14\u662f\u9488\u5bf9\u67d0\u4e2a stream \u4e00\u76f4\u4e22\u5305\uff1f"),(0,p.kt)("p",null,"\u53ef\u80fd\u662f\u56e0\u4e3a\u8fd9\u79cd\u573a\u666f\u4e0b\u89e6\u53d1\u4e86\u4e2d\u95f4\u73af\u8282\u7684\u6d41\u91cf\u7ba1\u63a7\uff0c\u6545\u610f\u4e22\u5305\u4e86\uff08\u6bd4\u5982 proxy\u3001slb\u3001\u4ea4\u6362\u673a\u90fd\u6709\u53ef\u80fd\u505a\u8fd9\u79cd\u9009\u62e9\u6027\u7684\u4e22\u5305\uff09"),(0,p.kt)("p",null,"\u8fd9\u91cc server \u8ba4\u4e3a\u8fde\u63a5\u65ad\u5f00\uff0c\u6ca1\u6709\u53d1 reset \u548c fin,\u56e0\u4e3a\u6ca1\u5fc5\u8981\uff0cserver \u8ba4\u4e3a\u7f51\u7edc\u8fde\u901a\u6027\u51fa\u4e86\u95ee\u9898\u3002client \u8fd8\u4e0d\u77e5\u9053 server \u4e0a\u8fd9\u4e2a\u8fde\u63a5\u6e05\u7406\u6389\u4e86\uff0c\u7b49 client \u56de\u590d\u4e86\u4e00\u4e2a window update\uff0cserver \u65e9\u5c31\u8ba4\u4e3a\u8fd9\u4e2a\u8fde\u63a5\u65e9\u65ad\u4e86\uff0c\u7a81\u7136\u6536\u5230\u4e00\u4e2a update\uff0c\u83ab\u540d\u5176\u5999\uff0c\u53ea\u80fd reset\u3002"),(0,p.kt)("h2",{id:"\u63a5\u6536\u7a97\u53e3\u548c-so_rcvbuf-\u7684\u5173\u7cfb"},"\u63a5\u6536\u7a97\u53e3\u548c SO_RCVBUF \u7684\u5173\u7cfb"),(0,p.kt)("p",null,"\u521d\u59cb\u63a5\u6536\u7a97\u53e3\u4e00\u822c\u662f mss \u4e58\u4ee5\u521d\u59cb cwnd\uff08\u4e3a\u4e86\u548c\u6162\u542f\u52a8\u903b\u8f91\u517c\u5bb9\uff0c\u4e0d\u60f3\u4e00\u4e0b\u5b50\u51b2\u51fb\u5230\u7f51\u7edc\uff09\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e SO_RCVBUF\uff0c\u90a3\u4e48\u4f1a\u6839\u636e net.ipv4.tcp_rmem \u52a8\u6001\u53d8\u5316\uff0c\u5982\u679c\u8bbe\u7f6e\u4e86 SO_RCVBUF\uff0c\u90a3\u4e48\u63a5\u6536\u7a97\u53e3\u8981\u5411\u4e0b\u9762\u63cf\u8ff0\u7684\u503c\u9760\u62e2\u3002"),(0,p.kt)("p",null,"\u521d\u59cb cwnd \u53ef\u4ee5\u5927\u81f4\u901a\u8fc7\u67e5\u770b\u5230\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-bash"},'ss -itmpn dst "10.81.212.8"\nState      Recv-Q Send-Q Local Address:Port  Peer Address:Port\nESTAB      0      0      10.xx.xx.xxx:22     10.yy.yy.yyy:12345  users:(("sshd",pid=1442,fd=3))\n         skmem:(r0,rb369280,t0,tb87040,f4096,w0,o0,bl0,d92)\n\n#Here we can see this socket has Receive Buffer 369280 bytes, and Transmit Buffer 87040 bytes.\n#Keep in mind the kernel will double any socket buffer allocation for overhead.\n#So a process asks for 256 KiB buffer with setsockopt(SO_RCVBUF) then it will get 512 KiB buffer space. This is described on man 7 tcp.\n')),(0,p.kt)("p",null,"\u521d\u59cb\u7a97\u53e3\u8ba1\u7b97\u7684\u4ee3\u7801\u903b\u8f91\uff0c\u91cd\u70b9\u5728 18 \u884c\uff1a"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"\n/* TCP initial congestion window as per rfc6928 */\n#define TCP_INIT_CWND           10\n\n/* 3\\. Try to fixup all. It is made immediately after connection enters\n *    established state.\n */\nvoid tcp_init_buffer_space(struct sock *sk)\n{\n        int tcp_app_win = sock_net(sk)->ipv4.sysctl_tcp_app_win;\n        struct tcp_sock *tp = tcp_sk(sk);\n        int maxwin;\n\n        if (!(sk->sk_userlocks & SOCK_SNDBUF_LOCK))\n                tcp_sndbuf_expand(sk);\n\n        //\u521d\u59cb\u6700\u5927\u63a5\u6536\u7a97\u53e3\u8ba1\u7b97\u8fc7\u7a0b\n        tp->rcvq_space.space = min_t(u32, tp->rcv_wnd, TCP_INIT_CWND * tp->advmss);\n        tcp_mstamp_refresh(tp);\n        tp->rcvq_space.time = tp->tcp_mstamp;\n        tp->rcvq_space.seq = tp->copied_seq;\n\n        maxwin = tcp_full_space(sk);\n\n        if (tp->window_clamp >= maxwin) {\n                tp->window_clamp = maxwin;\n\n                if (tcp_app_win && maxwin > 4 * tp->advmss)\n                        tp->window_clamp = max(maxwin -\n                                               (maxwin >> tcp_app_win),\n                                               4 * tp->advmss);\n        }\n\n        /* Force reservation of one segment. */\n        if (tcp_app_win &&\n            tp->window_clamp > 2 * tp->advmss &&\n            tp->window_clamp + tp->advmss > maxwin)\n                tp->window_clamp = max(2 * tp->advmss, maxwin - tp->advmss);\n\n        tp->rcv_ssthresh = min(tp->rcv_ssthresh, tp->window_clamp);\n        tp->snd_cwnd_stamp = tcp_jiffies32;\n}\n")),(0,p.kt)("p",null,"\u4f20\u8f93\u8fc7\u7a0b\u4e2d\uff0c\u6700\u5927\u63a5\u6536\u7a97\u53e3\u4f1a\u52a8\u6001\u8c03\u6574\uff0c\u5f53\u6307\u5b9a\u4e86 SO_RCVBUF \u540e\uff0c\u5b9e\u9645 buffer \u662f\u4e24\u500d SO_RCVBUF\uff0c\u4f46\u662f\u8981\u5206\u51fa\u4e00\u90e8\u5206\uff082^net.ipv4.tcp_adv_win_scale)\u6765\u4f5c\u4e3a\u4e71\u5e8f\u62a5\u6587\u7f13\u5b58\u3002"),(0,p.kt)("blockquote",null,(0,p.kt)("p",{parentName:"blockquote"},"1.net.ipv4.tcp_adv_win_scale = 2 //2.6 \u5185\u6838\uff0c3.1 \u4e2d\u8fd9\u4e2a\u503c\u9ed8\u8ba4\u662f 1")),(0,p.kt)("p",null,"\u5982\u679c SO_RCVBUF \u662f 8K\uff0c\u603b\u5171\u5c31\u662f 16K\uff0c\u7136\u540e\u5206\u51fa 2^2 \u5206\u4e4b\u4e00\uff0c\u4e5f\u5c31\u662f 4 \u5206\u4e4b\u4e00\uff0c\u8fd8\u5269 12K \u5f53\u505a\u63a5\u6536\u7a97\u53e3\uff1b\u5982\u679c\u8bbe\u7f6e\u7684 32K\uff0c\u90a3\u4e48\u63a5\u6536\u7a97\u53e3\u662f 48K\u3002"),(0,p.kt)("pre",null,(0,p.kt)("code",{parentName:"pre",className:"language-c"},"\nstatic inline int tcp_win_from_space(const struct sock *sk, int space)\n{//space \u4f20\u5165\u7684\u65f6\u5019\u5c31\u5df2\u7ecf\u662f 2*SO_RCVBUF\u4e86\n        int tcp_adv_win_scale = sock_net(sk)->ipv4.sysctl_tcp_adv_win_scale;\n\n        return tcp_adv_win_scale <= 0 ?\n                (space>>(-tcp_adv_win_scale)) :\n                space - (space>>tcp_adv_win_scale); //sysctl\u53c2\u6570tcp_adv_win_scale\n}\n")),(0,p.kt)("p",null,"\u63a5\u6536\u7a97\u53e3\u6709\u6700\u5927\u63a5\u6536\u7a97\u53e3\u548c\u5f53\u524d\u53ef\u7528\u63a5\u6536\u7a97\u53e3\u3002"),(0,p.kt)("p",null,"\u4e00\u822c\u6765\u8bf4\u4e00\u6b21\u4e2d\u65ad\u57fa\u672c\u90fd\u4f1a\u5c06 buffer \u4e2d\u7684\u5305\u90fd\u53d6\u8d70\u3002"),(0,p.kt)("p",null,(0,p.kt)("img",{alt:"net18.png",src:n(2220).Z,width:"800",height:"702"})),(0,p.kt)("p",null,"\u4e0a\u56fe\u662f\u56db\u4e2a batch insert \u8bed\u53e5\uff0c\u53ef\u4ee5\u770b\u5230\u7eff\u8272\u63a5\u6536\u7a97\u53e3\u968f\u7740\u6570\u636e\u7684\u4f20\u8f93\u8d8a\u6765\u8d8a\u5927\uff0c\u56fe\u4e2d\u84dd\u8272\u7ad6\u76f4\u90e8\u5206\u57fa\u672c\u8868\u793a SQL \u4e0a\u4f20\uff0c\u4e24\u4e2a\u84dd\u8272\u7ad6\u76f4\u6761\u7684\u95f4\u9694\u4ee3\u8868\u8fd9\u4e2a insert \u5728\u670d\u52a1\u5668\u4e0a\u771f\u6b63\u7684\u6267\u884c\u65f6\u95f4\u3002\u8fd9\u56fe\u975e\u5e38\u9661\u5ced\uff0c\u8868\u793a\u4e0a\u4f20\u6ca1\u6709\u4efb\u4f55\u74f6\u9888\u3002"),(0,p.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"\u4e00\u822c\u6765\u8bf4\u7edd\u5bf9\u4e0d\u8981\u5728\u7a0b\u5e8f\u4e2d\u624b\u5de5\u8bbe\u7f6e SO_SNDBUF \u548c SO_RCVBUF\uff0c\u5185\u6838\u81ea\u52a8\u8c03\u6574\u6bd4\u4f60\u505a\u7684\u8981\u597d\uff1b"),(0,p.kt)("li",{parentName:"ul"},"SO_SNDBUF \u4e00\u822c\u4f1a\u6bd4\u53d1\u9001\u6ed1\u52a8\u7a97\u53e3\u8981\u5927\uff0c\u56e0\u4e3a\u53d1\u9001\u51fa\u53bb\u5e76\u4e14 ack \u4e86\u7684\u624d\u80fd\u4ece SO_SNDBUF \u4e2d\u91ca\u653e\uff1b"),(0,p.kt)("li",{parentName:"ul"},"TCP \u63a5\u6536\u7a97\u53e3\u8ddf SO_RCVBUF \u5173\u7cfb\u5f88\u590d\u6742\uff1b"),(0,p.kt)("li",{parentName:"ul"},"SO_RCVBUF \u592a\u5c0f\u5e76\u4e14 rtt \u5f88\u5927\u7684\u65f6\u5019\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff1b"),(0,p.kt)("li",{parentName:"ul"},"\u63a5\u6536\u7a97\u53e3\u6bd4\u53d1\u9001\u7a97\u53e3\u590d\u6742\u591a\u4e86\uff1b"),(0,p.kt)("li",{parentName:"ul"},"\u53d1\u9001\u7a97\u53e3/SO_SNDBUF--\u53d1\u9001\u4ed3\u5e93\uff0c\u5e26\u5bbd/\u62e5\u585e\u7a97\u53e3--\u9a6c\u8def\u901a\u7545\u7a0b\u5ea6\uff0c\u63a5\u6536\u7a97\u53e3/SO_RCVBUF--\u63a5\u6536\u4ed3\u5e93\uff1b"),(0,p.kt)("li",{parentName:"ul"},"\u53d1\u9001\u4ed3\u5e93\u3001\u9a6c\u8def\u901a\u7545\u7a0b\u5ea6\u3001\u63a5\u6536\u4ed3\u5e93\u4e00\u8d77\u51b3\u5b9a\u4e86\u4f20\u8f93\u901f\u5ea6--\u7c7b\u6bd4\u4e00\u4e0b\u5feb\u9012\u8fc7\u7a0b\u3002")),(0,p.kt)("p",null,"\u603b\u4e4b\u8bb0\u4f4f\u4e00\u53e5\u8bdd\uff1a\u4e0d\u8981\u8bbe\u7f6e socket \u7684 SO_SNDBUF \u548c SO_RCVBUF\u3002"),(0,p.kt)("p",null,"\u8f6c\u81ea",(0,p.kt)("a",{parentName:"p",href:"https://segmentfault.com/a/1190000020883855"},"\u76f4\u51fb\u6848\u53d1\u73b0\u573a\uff01TCP 10 \u500d\u5ef6\u8fdf\u7684\u771f\u76f8\u662f\uff1f")))}m.isMDXComponent=!0},64894:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net1-a8e830e58e50ba4777440c529659a7f9.png"},22485:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net10-0bdd33aa29f57c72962906645e2fa085.png"},26806:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net11-1a40050706266c209c855079be939900.png"},91874:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net12-b854c63d2a6e03743f1b91e91b65e6ee.png"},70239:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net13-135704652fd183a6e6780f76c2fe8530.png"},30983:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net14-25fae77ea7934d129019a45d79ac2218.png"},76541:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net15-b98107d8f374b70e91bcaed94ad0b4f9.png"},59292:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net16-117d7e619209ebc36f5bf61c324f09a4.png"},84013:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net17-45fed25af238a00ac678fe99aa8bf025.png"},2220:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net18-714ff76a7b6d2aa5a5a4126ebebe741b.png"},40812:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net2-d67a68b921dd6bc540d6f5bd35dd93a3.png"},96967:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net3-5cc2c7542e436f063b9c2b1685f8b2d6.png"},97368:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net4-e267bec36bb0f39602c4214f96cee2ec.png"},28870:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net5-1172839009c2c2bfc6343e205f3c5321.png"},75482:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net6-72a8f0dffc2b02a1fed75ca90dd240e7.png"},23422:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net7-4237129109719e9d88e46726b5a4fc61.png"},34159:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net8-61658af9951c33c5544f749d11ccd625.png"},39859:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/net9-ba2cf21183701590b52cab027b94dca6.png"}}]);