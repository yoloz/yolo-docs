:::info

- `/etc/rc.local`是  `Sysvinit`技术用于系统的`init`进程在启动过程中最后执行的任务,此时只需要将自启动命令写入文件中即可(centos、ubuntu 较早版本)；
- centos、ubuntu 之后使用`Systemd`技术启动，开机不会运行`init`进程，为了兼容默认提供了一个名为`rc-local`的`systemd`服务，负责系统启动后执行`/etc/rc.d/rc.local`中的命令；
- `/etc/init.d`：目录存放开机初始化启动脚本，将脚本放入如：网络，环境变量等
- `/etc/fstab`：系统初始化后，程序启动前加载，如磁盘挂载，mount 命令等

:::

## 使用 systemd 服务

:::info

- `systemd`默认读取`/etc/systemd/system`下的文件，ubuntu 中该目录下的文件会链接`/lib/systemd/system/`下的文件，euler 中则是链接`/usr/lib/systemd/system`下的文件;

:::
在`/etc/systemd/system` 下创建`custom_auto_start.service`文件，将执行脚本设置成系统服务:

```log
[Unit]
Description=The app auto run when reboot
After=default.target

[Service]
ExecStart=/xxxx/auto_start.sh

[Install]
WantedBy=default.target
```

一般正常的启动文件主要分成三部分：

- Unit 段: 启动顺序与依赖关系
- Service 段: 启动行为,如何启动，启动类型
- Install 段: 定义如何安装这个配置文件，即怎样做到开机启动

重启 systemd 服务、设置开机自启动

```bash
# 重载系统服务
[root@localhost ~]# systemctl daemon-reload
[root@localhost ~]# systemctl enable auto_start.service
[root@localhost ~]# reboot
```

下文主要说明`rc.local`的`systemd`服务配置：

## centos

文件`/etc/rc.local`是个软链接，实际文件`/etc/rc.d/rc.local`不具有执行权限,需要给文件添加执行权限:

```shell
[test@localhost ~]$ ll /etc/rc.local
lrwxrwxrwx. 1 root root 13 Jan 29 17:54 /etc/rc.local -> rc.d/rc.local
[test@localhost ~]$
```

下文为欧拉系统例子:

```bash
# >=22.03
function eulerAuto() {

  sudo -s <<EOF

if [[ ! -f /etc/rc.d/rc.local ]]; then
  echo "#!/bin/bash" >> /etc/rc.d/rc.local
fi

chmod +x /etc/rc.d/rc.local

sed -i '/mysqld start/d' /etc/rc.d/rc.local
sed -i '/nm_start.sh -d/d' /etc/rc.d/rc.local
sed -i '/ui_start.sh -d/d' /etc/rc.d/rc.local

echo "/etc/init.d/mysqld start" >>/etc/rc.d/rc.local
echo "sh /xxxx/nm_start.sh -d >/dev/null" >>/etc/rc.d/rc.local
echo "sh /xxxx/ui_start.sh -d >/dev/null" >>/etc/rc.d/rc.local

systemctl restart rc-local.service

exit

EOF

}
```

### chkconfig

在 CentOS 中专门提供了 chkconfig 命令来设置或者取消开机自启动服务

```bash
chkconfig --list                 #当前系统已经设置的各个服务在各个运行级别下的开闭状态
chkconfig --list  sshd           #查看具体服务
chkconfig servicename on/off     #启动关闭
```

:::note
如果这个服务尚未被添加到 chkconfig 列表中，则现需要使用 `--add` 参数将其添加进去`chkconfig --add sshd`
:::

## ubuntu

查看`/lib/systemd/system/rc.local.service`(Ubuntu18.04),`/usr/lib/systemd/system/rc-local.service`(Ubuntu22.04)：

```log
#  SPDX-License-Identifier: LGPL-2.1+
#
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

# This unit gets pulled automatically into multi-user.target by
# systemd-rc-local-generator if /etc/rc.local is executable.
[Unit]
Description=/etc/rc.local Compatibility
Documentation=man:systemd-rc-local-generator(8)
ConditionFileIsExecutable=/etc/rc.local
After=network.target

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
RemainAfterExit=yes
GuessMainPID=no
```

一般`systemd`正常启动文件主要分成三部分:Unit,Service,Install,缺少了 Install 段，需要在后面加上 Install 段:

```log
[Install]
WantedBy=multi-user.target
Alias=rc-local.service
```

:::caution

- ubuntu 18.04、22.04 默认没有`/etc/rc.local`这个文件，需要手动创建`sudo touch /etc/rc.local`，然后把自启动服务添加进去；
- 设置权限`chmod 755 /etc/rc.local`；

:::

例子如下:

```bash
# >=18.04
function ubuntuAuto() {

  if [[ $a =~ "ubuntu 18.04" ]]; then
    localpath="/lib/systemd/system/rc.local.service"
  fi

  if [[ $a =~ "ubuntu 22.04" ]]; then
    localpath="/usr/lib/systemd/system/rc-local.service"
  fi

  Install_unit=$(grep -o 'Install' ${localpath})

  sudo -s <<EOF

if [[ -z "$Install_unit" ]]; then
  echo "" >> ${localpath}
  echo "[Install]" >> ${localpath}
  echo "WantedBy=multi-user.target" >> ${localpath}
  echo "Alias=rc-local.service" >> ${localpath}
fi

if [[ ! -f /etc/rc.local ]]; then
  echo "#!/bin/sh -e" >> /etc/rc.local
fi

sed -i '/mysqld start/d' /etc/rc.local
sed -i '/nm_start.sh -d/d' /etc/rc.local
sed -i '/ui_start.sh -d/d' /etc/rc.local
sed -i '/exit 0/d' /etc/rc.local

echo "/etc/init.d/mysqld start" >>/etc/rc.local
echo "sh /xxxx/nm_start.sh -d >/dev/null" >>/etc/rc.local
echo "sh /xxxx/ui_start.sh -d >/dev/null" >>/etc/rc.local
echo "exit 0" >> /etc/rc.local

chmod +x /etc/rc.local
systemctl disable rc-local
systemctl enable rc-local
systemctl restart rc-local.service

exit

EOF

}
```

:::note
tee 等价于>,tee -a 等价于>>
:::

## redis 自启动

ubuntu18.04、22.04 通过 apt(dpkg)安装后，服务即启动且自启也可用，但是 euler22.03 安装后服务未启动且自启也需配置,操作如下：

```bash
[root@localhost ~]# systemctl enable redis
[root@localhost ~]# systemctl restart redis
```
