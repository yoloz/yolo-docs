## 通信模型

[参考](https://www.cnblogs.com/qishui/p/5428938.html)

### OSI 七层模型

OSI（Open System Interconnect），即开放式系统互联。 一般都叫 OSI 参考模型，是 ISO（国际标准化组织）组织在 1985 年研究的网络互连模型。其含义就是推荐所有公司使用这个规范来控制网络。这样所有公司都有相同的规范，就能互联了。

OSI 定义了网络互连的七层框架，每一层实现各自的功能和协议，并完成与相邻层的接口通信。某一层的服务就是该层及其下各层的一种能力，它通过接口提供给更高一层。各层所提供的服务与这些服务是怎么实现的无关。

![OSI1](/docs/network/osi/OSI1.png)

## TCP/IP 五层模型

TCP/IP 五层协议和 OSI 的七层协议对应关系如下：

![OSI2](/docs/network/osi/OSI2.png)

在每一层都工作着不同的设备，比如我们常用的交换机就工作在数据链路层的，一般的路由器是工作在网络层的

![OSI3](/docs/network/osi/OSI3.png)

在每一层实现的协议也各不同，即每一层的服务也不同.下图列出了每层主要的协议。

![OSI4](/docs/network/osi/OSI4.png)

当我们应用程序用 TCP 传输数据的时候，数据被送入协议栈中，然后逐个通过每一层，知道最后到物理层数据转换成比特流，送入网络。而再这个过程中，每一层都会对要发送的数据加一些首部信息。整个过程如下图

![OSI5](/docs/network/osi/OSI5.png)

如图可以看出：

- 每一层数据是由上一层数据+本层首部信息组成的，其中每一层的数据,称为本层的协议数据单元,即 PDU。
- 应用层数据在传输层添加 TCP 报头后得到的 PDU 被称为 Segment(数据段 )，图示为 TCP 段
- 传输层的数据（TCP 段）传给网络层,网络层添加 IP 报头得到的 PDU 被称为 Packet(数据包); 图示为 IP 数据包
- 网络层数据报（IP 数据包）被传递到数据链路层,封装数据链路层报头得到的 PDU 被称为 Frame(数据帧)，图示为以太网帧。
- 最后,帧被转换为比特,通过网络介质传输。

这种协议栈逐层向下传递数据,并添加报头和报尾的过程称为封装。反之接收方接收后会逐层向上传递并处理数据。

## TCP/UDP 协议

[(传输层)TCP 协议](https://www.cnblogs.com/kzang/articles/2582957.html)

TCP（Transmission Control Protocol 传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由 IETF 的 RFC 793 定义。在简化的计算机网络 OSI 模型中，它完成第四层传输层所指定的功能，用户数据报协议（UDP）是同一层内另一个重要的传输协议。

在因特网协议族（Internet protocol suite）中，TCP 层是位于 IP 层之上，应用层之下的中间层。不同主机的应用层之间经常需要可靠的、像管道一样的连接，但是 IP 层不提供这样的流机制，而是提供不可靠的包交换。

- TCP 的优点

可靠，稳定,TCP 的可靠体现在 TCP 在传递数据之前，会有三次握手来建立连接，而且在数据传递时，有确认、窗口、重传、拥塞控制机制，在数据传完后，还会断开连接用来节约系统资源。

- TCP 的缺点

慢，效率低，占用系统资源高，易被攻击,TCP 在传递数据之前，要先建连接，这会消耗时间，而且在数据传递时，确认机制、重传机制、拥塞控制机制等都会消耗大量的时间，而且要在每台设备上维护所有的传输连接，事实上，每个连接都会占用系统的 CPU、内存等硬件资源。

由于 TCP 存在确认机制和三次握手机制，这些是导致 TCP 容易被人利用，实现 DOS、DDOS、CC 等攻击。

- TCP 应用场景

当对网络通讯质量有要求的时候，比如：整个数据要准确无误的传递给对方，这往往用于一些要求可靠的应用，比如 HTTP、HTTPS、FTP 等传输文件的协议，POP、SMTP 等邮件传输的协议

UDP 是 User Datagram Protocol 的简称， 中文名是用户数据报协议，是 OSI（Open System Interconnection，开放式系统互联） 参考模型中一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务，IETF RFC 768 是 UDP 的正式规范。UDP 在 IP 报文的协议号是 17。

- UDP 的优点

快，比 TCP 稍安全,UDP 没有 TCP 的握手、确认、窗口、重传、拥塞控制等机制，UDP 是一个无状态的传输协议，所以它在传递数据时非常快。没有 TCP 的这些机制，UDP 较 TCP 被攻击者利用的漏洞就要少一些。但 UDP 也是无法避免攻击的，比如：UDP Flood 攻击……

- UDP 的缺点

不可靠，不稳定,因为 UDP 没有 TCP 那些可靠的机制，在数据传递时，如果网络质量不好，就会很容易丢包

- UDP 应用场景

当对网络通讯质量要求不高的时候，要求网络通讯速度能尽量的快，这时就可以使用 UDP。在日常生活中，常见使用 UDP 协议的应用比如：QQ 语音、QQ 视频、TFTP 等

TCP 和 UDP 使用 IP 协议从一个网络传送数据包到另一个网络。把 IP 想像成一种高速公路，它允许其它协议在上面行驶并找到到其它电脑的出口。TCP 和 UDP 是高速公路上的“卡车”，它们携带的货物就是像 HTTP，文件传输协议 FTP 这样的协议等。

![tcp2udp1](/docs/network/tcp2udp1.png)

## HTTP 协议

HTTP（超文本传输协议）是利用 TCP 在两台电脑(通常是 Web 服务器和客户端)之间传输信息的协议。

![httpformat](/docs/network/httpformat.png)

HTTP 连接使用的是”请求-响应”方式，不仅在请求时建立连接，而且客户端向服务器端请求后，服务器才返回数据。

### Https 抓包解密

https 的数据包是用对称秘钥（https 协议协商出来的随机数）加密后的密文。

对称秘钥在传输线路上是密文的（被非对称加密过），但是在 client、server 端是明文的（因为要用于加解密）。

对称秘钥如何获取？浏览器有一个接口对称秘钥会保存在”SSLKEYLOGFILE"中，wireshark 有读取对称秘钥文件的接口，这样一来，就可以抓包和解密了。

说明：不要以为会获取对称秘钥就可以破解网络上任意的 https 数据包了。这个对称秘钥是临时协商出来的。你下一次访问，对称秘钥又要改变了。所以，你不参与到 client、server 端，只参与到传输过程抓包，是无法获取当时的对称秘钥的（被非对称秘钥加了密），也就无法解密 https 的。

## Socket

套接字（socket）是通信的基石，是支持 TCP/IP 协议的网络通信的基本操作单元。它是网络通信过程中端点的抽象表示，包含进行网络通信必须的五种信息：连接使用的协议，本地主机的 IP 地址，本地进程的协议端口，远地主机的 IP 地址，远地进程的协议端口。

TCP/IP 只是一个协议栈，就像操作系统的运行机制一样，必须要具体实现，同时还要提供对外的操作接口。就像操作系统会提供标准的编程接口，比如 Win32 编程接口一样，TCP/IP 也必须对外提供编程接口，这就是 Socket 编程接口。

在 Socket 编程接口里，设计者提出了一个很重要的概念，那就是 socket。这个 socket 跟文件句柄很相似，实际上在 BSD 系统里就是跟文件句柄一样存放在一样的进程句柄表里。这个 socket 其实是一个序号，表示其在句柄表中的位置。这一点，我们已经见过很多了，比如文件句柄，窗口句柄等等。这些句柄，其实是代表了系统中的某些特定的对象，用于在各种函数中作为参数传入，以对特定的对象进行操作--这其实是 C 语言的问题，在 C++语言里，这个句柄其实就是 this 指针，实际就是对象指针啦。

## ARP 与 RARP 协议

[参考](https://www.cnblogs.com/kzang/articles/2582349.html)

![arp2rarp1](/docs/network/arp2rarp1.png)

教材上把 ARP 协议划到网络层，是因为 ARP 协议属于 TCP/IP 协议簇。在 TCP/IP 模型中，它所有定义的协议是在网际层上的。

再看按照 OSI 的标准，数据在传递时每层会加上自己的信息。当网络层的 IP 包进入链路层时，链路层通过 ARP 协议添加链路信息，而这不是网络层的功能。所以有很多人说 ARP 是链路层的。

如此可以，**在 OSI 模型中 ARP 协议属于链路层；在 TCP/IP 模型中，ARP 协议属于网络层**。

### ARP

ARP 协议是“Address Resolution Protocol”（地址解析协议）的缩写。每一个主机都设有一个 ARP 高速缓存(ARP cache),里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

在局域网中，网络中实际传输的是“帧”，帧里面是有目标主机的 MAC 地址的。在以太网中，一个主机要和另一个主机进行直接通信，必须要知道目标主机的 MAC 地址。但这个目标 MAC 地址是如何获得的呢？它就是通过地址解析协议获得的。所谓“地址解析”就是主机在发送帧前将目标 IP 地址转换成目标 MAC 地址的过程。ARP 协议的基本功能就是通过目标设备的 IP 地址，查询目标设备的 MAC 地址，以保证通信的顺利进行。

- 步骤

![arp1](/docs/network/arp/arp1.png)

- 注意
  - 网络上其他主机并不响应 ARP 询问,只有接收端主机接收到这个帧时,才向发送端主机做出这样的回应
  - ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题.若所要找的主机和源主机不在同一个局域网上,那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址,然后把分组发送给这个路由器,让这个路由器把分组转发给下一个网络.剩下的工作就由下一个网络来做
  - 从 IP 地址到硬件地址的解析是自动进行的,主机的用户对这种地址解析过程是不知道的.
  - 主机或路由器要和本网络上另一个已知 IP 地址的主机或路由器进行通信,ARP 协议会自动地将该 IP 地址解析为链路层所需要的硬件地址
- 四种典型情况
  - 发送方是主机,要把 IP 数据报发送到本网络上的另一个主机.这时用 ARP 找到目的主机的硬件地址
  - 发送方是主机要把 IP 数据报发送到其他网络的主机.这时 ARP 找到本网络上某个路由器硬件地址.剩下工作由这个路由器完成
  - 发送方是路由器,要把 IP 数据报转发到本网络上的一个主机.这时用 ARP 找到目的主机的硬件地址
  - 发送方是路由器,要把 IP 数据报转发到另一个网络上的一个主机.这时用 ARP 找到本网络上的一个路由器的硬件地址.剩下的工作由这个路由器来完成

### RARP

RARP 协议是"Reverse Address Resolution Protocol"（反向地址转换协议）的缩写。RARP 协议允许局域网的物理机器从网关服务器的 ARP 表或者缓存上请求其 IP 地址。网络管理员在局域网网关路由器里创建一个表以映射物理地址（MAC）和与其对应的 IP 地址。当设置一台新的机器时，其 RARP 客户机程序需要向路由器上的 RARP 服务器请求相应的 IP 地址。假设在路由表中已经设置了一个记录，RARP 服务器将会返回 IP 地址给机器，此机器就会存储起来以便日后使用。**RARP 协议曾经作为逆向的地址解析协议和 ARP 配合使用，但是现在 RARP 协议已经被淘汰，在 DHCP（动态主机配置协议）协议中已经包含了 RARP 的功能，所以大家现在主要关注的是 ARP**。

## ICMP 协议

ICMP（Internet Control Message Protocol）Internet 控制报文协议。制定万维网规格的 IETF 在 1981 年将 RFC7922 作为 ICMP 的基本规格整理出来了。那个 RFC792 的开头部分里写着**ICMP 是 IP 的不可缺少的部分，所有的 IP 软件必须实现 ICMP 协议**。ICMP 是为了分担 IP 一部分功能而被制定出来的。

- 要点
  - 允许主机和路由器报告差错情况和提供有关异常情况的报告
  - ICMP 不是高层协议,而是 IP 层的协议
  - ICMP 报文作为 IP 层数据报的数据,加上数据报的首部,组成 IP 数据报发送出去
  - ICMP 报文的前 4 个字节是统一的格式,共有三个字段：即类型,代码和检验和.接着的 4 个字节的内容与 ICMP 的类型有关

种类

- ICMP 差错报告报文
  - 终点不可达
  - 源点抑制(Source quench)
  - 时间超过
  - 参数问题
  - 改变路由（重定向）(Redirect)
- ICMP 询问报文:

  - 回送请求和回答报文
  - 时间戳请求和回答报文

- 不应发送 ICMP 差错报告报文的情况:
  - 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
  - 多播地址的数据报都不发送 ICMP 差错报告报文
  - 特殊地址(如 127.0.0.0 或 0.0.0.0)的数据报不发送 ICMP 差错报告报文

[完全理解 icmp 协议](https://www.cnblogs.com/iiiiher/p/8513748.html)

## IGMP 协议

IGMP(Internet Group Management Protocol)互联网组管理协议是 TCP/IP 协议族中负责 IP 组播成员管理的协议，用来在 IP 主机和与其直接相邻的组播路由器之间建立、维护组播组成员关系。到目前为止，IGMP 有三个版本：

- IGMPv1(由 RFC 1112 定义)
- IGMPv2(由 RFC 2236 定义)
- IGMPv3(由 RFC 3376 定义)

所有版本的 IGMP 都支持 ASM(Any-Source Multicast，任意信源组播)模型;IGMPv3 可以直接应用于 SSM(Source-Specific Multicast，指定信源组播)模型，而 IGMPv1 和 IGMPv2 则需要在 IGMP SSM Mapping 技术的支持下才能应用于 SSM 模型。

两个阶段:

- 加入  
  当主机加入新的多播组时,向多播组的多播地址发送 IGMP 报文,声明自己要成为该组的成员.本地的多播路由器收到 IGMP 报文后,将组成员关系转发给因特网上的其他多播路由器
- 询问  
  周期性地探询本地局域网上的主机,以便知道这些主机是否还继续是组的成员

注意:

- 因为组成员关系是动态的，因此本地多播路由器要只要对某个组有一个主机响应，那么多播路由器就认为这个组是活跃的
- 但一个组在经过几次的探询后仍然没有一个主机响应，则不再将该组的成员关系转发给其他的多播路由器

**IGMP 使用 IP 数据报传递其报文（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务**

具体措施:

- 在主机和多播路由器之间的所有通信都是使用 IP 多播
- 多播路由器在探询组成员关系时，只需要对所有的组发送一个请求信息的询问报文，而不需要对每一个组发送一个询问报文。默认的询问速率是每 125 秒发送一次
- 当同一个网络上连接有几个多播路由器时，它们能够迅速和有效地选择其中的一个来探询主机的成员关系
- 在 IGMP 的询问报文中有一个数值 N，它指明一个最长响应时间（默认值为 10 秒）。当收到询问时，主机在 0 到 N 之间随机选择发送响应所需经过的时延。对应于最小时延的响应最先发送
- 同一个组内的每一个主机都要监听响应，只要有本组的其他主机先发送了响应，自己就可以不再发送响应了

[IGMP 工作机制](https://network.51cto.com/art/201901/590835.htm)
