## TCP 数据段格式

[原文](https://blog.csdn.net/qq_32998153/article/details/79680704)

TCP 报文段首部的前 20 个字节是固定的（下图），后面有 4n 字节是根据需要而增加的选项（n 是整数）。因此 TCP 首部的最小长度是 20 字节。

![tcpformat](/docs/network/tcpformat.png)

- 源端口和目的端口  
  各占 2 个字节，分别写入源端口和目的端口
- 序号  
  占 4 字节,序号范围是【0，2^32 - 1】，共 2^32（即 4294967296）个序号。
  序号增加到 2^32-1 后，下一个序号就又回到 0。也就是说，序号使用 mod 2^32 运算。TCP 是面向字节流的,在一个 TCP 连接中传送的字节流中的每一个字节都按顺序编号。整个要传送的字节流的起始序号必须在连接建立时设置。首部中的序号字段值则是指的是本报文段所发送的数据的第一个字节的序号。例如，一报文段的序号是 301，而接待的数据共有 100 字节。这就表明：本报文段的数据的第一个字节的序号是 301，最后一个字节的序号是 400。显然，下一个报文段（如果还有的话）的数据序号应当从 401 开始，即下一个报文段的序号字段值应为 401。这个字段的序号也叫“报文段序号”。
- 确认号  
  占 4 字节，是期望收到对方下一个报文段的第一个数据字节的序号。例如，B 正确收到了 A 发送过来的一个报文段，其序号字段值是 501，而数据长度是 200 字节（序号 501~700），这表明 B 正确收到了 A 发送的到序号 700 为止的数据。因此，B 期望收到 A 的下一个数据序号是 701，于是 B 在发送给 A 的确认报文段中把确认号置为 701。若确认号为 N，则表明：到序号 N-1 为止的所有数据都已正确收到。
- 数据偏移  
  占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。**这个字段实际上是指出 TCP 报文段的首部长度**。由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的，但应注意，“数据偏移”的单位是 32 位字（即以 4 字节的字为计算单位）。由于 4 位二进制数能表示的最大十进制数字是 15，因此数据偏移的最大值是 60 字节，这也是 TCP 首部的最大字节（即选项长度不能超过 40 字节）
  > 数据偏移以 32 位为长度单位，也就是 4 个字节，偏移最大为 15 个长度单位=15\*32 位=15\*4 字节
- 保留  
  占 6 位，保留为今后使用，但目前应置为 0
- 控制位

  - 紧急 URG（URGent）

    **当 URG=1 时，表明紧急指针字段有效**。它告诉系统此报文段中有紧急数据，应尽快发送（相当于高优先级的数据），而不要按原来的排队顺序来传送。例如，已经发送了很长的一个程序要在远地的主机上运行。但后来发现了一些问题，需要取消该程序的运行，因此用户从键盘发出中断命令。如果不使用紧急数据，那么这两个字符将存储在接收 TCP 的缓存末尾。只有在所有的数据被处理完毕后这两个字符才被交付接收方的应用进程。这样做就浪费了很多时间。当 URG 置为 1 时，发送应用进程就告诉发送方的 TCP 有紧急数据要传送。于是发送方 TCP 就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍然是普通数据。这时要与首部中紧急指针（Urgent Pointer）字段配合使用。

  - 确认 ACK（ACKnowledgment）

    **仅当 ACK = 1 时确认号字段才有效**，当 ACK = 0 时确认号无效。**TCP 规定，在连接建立后所有的传送的报文段都必须把 ACK 置为 1。**

  - 推送 PSH（PuSH）

  当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能收到对方的响应。在这种情况下，TCP 就可以使用推送（push）操作。这时，发送方 TCP 把 PSH 置为 1，并立即创建一个报文段发送出去。接收方 TCP 收到 PSH=1 的报文段，就尽快地（即“推送”向前）交付接收应用进程。而不用再等到整个缓存都填满了后再向上交付。

  - 复位 RST（ReSeT）

    **当 RST=1 时，表名 TCP 连接中出现了严重错误**（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立传输连接。**RST 置为 1 还用来拒绝一个非法的报文段或拒绝打开一个连接**。

  - 同步 SYN（SYNchronization）

  在连接建立时用来同步序号。**当 SYN=1 而 ACK=0 时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使 SYN=1 和 ACK=1**，因此 SYN 置为 1 就表示这是一个连接请求或连接接受报文。

  - 终止 FIN（FINis）

  用来释放一个连接。**当 FIN=1 时，表明此报文段的发送发的数据已发送完毕，并要求释放运输连接**。

- 窗口  
  占 2 字节,窗口值是【0，2^16-1】之间的整数。**窗口指的是发送本报文段的这方的接受窗口**（而不是自己的发送窗口）。窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。总之，窗口值作为接收方让发送方设置其发送窗口的依据。例如，发送了一个报文段，其确认号是 701，窗口字段是 1000.这就是告诉对方：“从 701 算起，我（即发送方报文段的一方）的接收缓存空间还可接受 1000 个字节数据（字节序号是 701~1700）。窗口字段明确指出了现在允许对方发送的数据量，窗口值经常在动态变化。
- 检验和  
  占 2 字节,检验和字段检验的范围包括首部和数据这两部分。和 UDP 用户数据报一样，在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。伪首部的格式和 UDP 用户数据报的伪首部一样。但应把伪首部第 4 个字段中的 17 改为 6（TCP 的协议号是 6）；把第 5 字段中的 UDP 中的长度改为 TCP 长度。接收方收到此报文段后，仍要加上这个伪首部来计算检验和。若使用 IPv6,则相应的伪首部也要改变。
- 紧急指针  
  占 2 字节,**紧急指针仅在 URG=1 时才有意义**，它指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据） 。因此，在紧急指针指出了紧急数据的末尾在报文段中的位置。当所有紧急数据都处理完时，TCP 就告诉应用程序恢复到正常操作。**即使窗口为 0 时也可以发送紧急数据**。
- 选项  
  长度可变，最长可达 4 字节。当没有使用“选项”时，TCP 的首部长度是 20 字节。

1. MSS 选项

TCP 最初只规定了一种选项，即最大报文段长度 MSS（Maximum Segment Szie）,**MSS 是每一个 TCP 报文段中的数据字段的最大长度**,并不是整个 TCP 报文段的最大长度，而是 TCP 报文段长度减去 TCP 首部长度。

**为什么要规定一个最大报文长度 MSS 呢？**

这并不是考虑接受方的接收缓存可能存放不下 TCP 报文段中的数据。实际上，**MSS 与接收窗口值没有关系**。我们知道，TCP 报文段的数据部分，至少要加上 40 字节的首部（TCP 首部 20 字节和 IP 首部 20 字节，这里还没有考虑首部中的可选部分）才能组装成一个 IP 数据报。若选择较小的 MSS 长度，网络的利用率就降低。设想在极端情况下，当 TCP 报文段只含有 1 字节的数据时，在 IP 层传输的数据报的开销至少有 40 字节（包括 TCP 报文段的首部和 IP 数据报的首部）。这样，对网络的利用率就不会超过 1/41。到了数据链路层还要加上一些开销。但反过来，若 TCP 报文段非常长，那么在 IP 层传输时就有可能要分解成多个短数据报片。在终点要把收到的各个短数据报片组成成原来的 TCP 报文段，当传输出错时还要进行重传，这些也都会使开销增大。

因此，MSS 应尽可能大些，只要在 IP 层传输时不需要分片就行。由于 IP 数据报所经历的路径是动态变化的，因此在这条路径上确定的不需要的分片的 MSS，如果改走另一条路径就可能需要进行分片。因此最佳的 MSS 是很难确定的。在连接过程中，双方都把自己能够支持的 MSS 写入这一字段，以后就按照这个数值传输数据，两个传送方向可以有不同的 MSS 值。若主机未填写这一项，则**MSS 的默认值是 536 字节长**。因此，所有在互联网上的主机都应该接受的报文段长度是 536+20（固定首部长度）=556 字节。

2. 窗口扩大选项

TCP 首部中窗口字段长度是 16 位，因此最大的窗口大小为 64K 字节。虽然这对早期的网络是足够用的，但对于包含卫星信道的网络，传播时延和宽带都很大，要获得高吞吐量需要更大的窗口大小。

窗口扩大选项占 3 字节，其中有一个字节表示移位值 S。新的窗口值等于 TCP 首部中的窗口位数从 16 增大到（16+S）。移位值允许使用的最大值是 14，相当于窗口最大值增大到 2^（16+14）-1=2^30-1。

窗口扩大选项可以在双方初始建立 TCP 连接时进行协商。如果连接的某一端实现了窗口扩大，当它不再需要扩大其窗口时，可发送 S=0 选项，使窗口大小回到 16

3. 时间戳选项

时间戳选项占 10 字节，其中最主要的字段是时间戳字段（4 字节）和时间戳回送回答字段（4 字节），时间戳选项有以下两个概念：

- **用来计算往返时间 RTT**。发送方在发送报文段时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段复制到时间戳回送回答字段。因此，发送方在收到确认报文后，可以准确地计算出 RTT 来。
- **用于处理 TCP 序号超过 2^32 的情况，这又称为防止序号绕回 PAWS**。我们知道，TCP 报文段的序号只有 32 位，而每增加 2^32 个序号就会重复使用原来用过的序号。当使用高速网络时，在一次 TCP 连接的数据传送中序号很可能被重复使用。例如，当使用 1.5Mbit/s 的速度发送报文段时，序号重复要 6 小时以上。但若用 2.5Gbit/s 的速率发送报文段，则不到 14 秒钟序号就会重复。为了使接收方能够把新的报文段和迟到很久的报文段区分开，则可以在报文段中加上这种时间戳。

## UDP 数据段格式

![udpformat](/docs/network/udpformat.jpg)

- 源端口（Source Port）  
  16 位的源端口域包含初始化通信的端口号。源端口和 IP 地址的作用是标识报文的返回地址。
- 目的端口（Destination Port）  
  16 位的目的端口域定义传输的目的。这个端口指明报文接收计算机上的应用程序地址接口。
- 长度（Length）  
  UDP 头和数据的总长度。
- 校验和（Check Sum）  
  和 TCP 和校验和一样，不仅对头数据进行校验，还对包的内容进行校验

## IP 数据段格式

[原文](https://www.cnblogs.com/kzang/articles/2582349.html)

![ip1](/docs/network/ip/ip1.png)

- 版本  
  占 4 位,指 IP 协议的版本,如 IPv4.6
- 首部长度  
  占 4 位,可表示的最大数值是 15 个单位(一个单位为 4 字节)因此 IP 的首部长度的最大值是 60 字节
- 区分服务  
  占 8 位,用来获得更好的服务,在旧标准中叫做服务类型,但实际上一直未被使用过.1998 年这个字段改名为区分服务.只有在使用区分服务(DiffServ)时,这个字段才起作用.一般的情况下都不使用这个字段
- 总长度  
  占 16 位,指首部和数据之和的长度,单位为字节,因此数据报的最大长度为 65535 字节,传送总长度必须不超过最大传送单元 MTU,所以有分片
- 标识  
  占 16 位,它是一个计数器,用来产生数据报的标识
- 标志(flag)  
  占 3 位,目前只有前两位有意义
  - MF  
    标志字段的最低位是 MF(More Fragment),MF=1 表示后面“还有分片”。MF=0 表示最后一个分片
  - DF  
    标志字段中间的一位是 DF(Don't Fragment),只有当 DF=0 时才允许分片
- 片偏移  
  占 12 位,指较长的分组在分片后某片在原分组中的相对位置.片偏移以 8 个字节为偏移单位

![ip2](/docs/network/ip/ip2.png)

- 生存时间  
  占 8 位,记为 TTL (Time To Live) 数据报在网络中可通过的路由器数的最大值,TTL 字段是由发送端初始设置一个 8 bit 字段.推荐的初始值由分配数字 RFC 指定,当前值为 64.发送 ICMP 回显应答时经常把 TTL 设为最大值 255
- 协议  
  占 8 位,指出此数据报携带的数据使用何种协议以便目的主机的 IP 层将数据部分上交给哪个处理过程, **1 表示为 ICMP 协议, 2 表示为 IGMP 协议, 6 表示为 TCP 协议, 17 表示为 UDP 协议**

![ip3](/docs/network/ip/ip3.png)

- 首部检验和  
  占 16 位,只检验数据报的首部不检验数据部分.这里不采用 CRC 检验码而采用简单的计算方法
- 源地址和目的地址  
  都各占 4 字节,分别记录源地址和目的地址

## ARP 协议报头格式

![arp2](/docs/network/arp/arp2.png)

- 硬件类型字段表示硬件地址的类型.它的值为 1 即表示以太网地址
- 协议类型字段表示要映射的协议地址类型.它的值为 0x0800 即表示 IP 地址
- 硬件地址长度和协议地址长度分别指出硬件地址和协议地址的长度,以字节为单位.对于以太网上 IP 地址的 ARP 请求或应答来说,它们的值分别为 6 和 4
- 操作类型指出四种操作类型,它们是 ARP 请求(值为 1)、ARP 应答(值为 2 )、RARP 请求(值为 3 )和 RARP 应答(值为 4 )
- 接下来的四个字段是发送端的硬件地址(在本例中是以太网地址)、发送端的协议地址( IP 地址)、目的端的硬件地址和目的端的协议地址.

## ICMP 报文格式

![icmp1](/docs/network/icmp/icmp1.png)

ICMP 地址掩码请求和应答报文
![icmp2](/docs/network/icmp/icmp2.jpg)

ICMP 时间戳请求和应答报文
![icmp3](/docs/network/icmp/icmp3.jpg)

ICMP 不可达报文
![icmp4](/docs/network/icmp/icmp4.jpg)

ICMP 回显请求和回显应答报文格式
![icmp5](/docs/network/icmp/icmp5.jpg)

ICMP 超时报文
![icmp6](/docs/network/icmp/icmp6.jpg)

ICMP 重定向报文
![icmp7](/docs/network/icmp/icmp7.jpg)

ICMP 路由器请求报文格式
![icmp8](/docs/network/icmp/icmp8.jpg)

ICMP 路由器通告报文格式
![icmp9](/docs/network/icmp/icmp9.jpg)

ICMP 源站抑制差错报文格式
![icmp10](/docs/network/icmp/icmp10.jpg)

[完全理解 icmp 协议](https://www.cnblogs.com/iiiiher/p/8513748.html)

## IGMP 报文格式

![igmp1](/docs/network/igmp1.jpg)

IGMP 使用 IP 数据报传递其报文（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务

## 以太网帧格式

![eth4](/docs/network/eth/eth4.png)

首先我们知道世界上有个协会叫作 IEEE，即电子工程师协会，里面有个分会，叫作 IEEE802 委员会，是专门来制定局域网各种标准的。而 802 下面还有个分部，叫作 802.3.就是我们经常提到的 IEEE802.3，这个部门制定的规范叫以太网规范，这个以太网规范中就定义了上面提到的“以太网首部”，**这个以太网规范，实际只定义了数据链路层中的 MAC 层和物理层规范。（注意数据链路层包括 MAC 子层和 LLC 子层两个子层，而 LLC 子层是在 IEEE802.2 中规范的）**。

以太网常用帧格式有两种，一种是 Ethernet II，另一种是 IEEE 802.3 格式。这两种格式区别是：Ethernet II 中包含一个 Type 字 段,而 IEEE 802.3 格式中,此位置是长度字段。 其中 Type 字段描述了，以太网首部 后面所跟数据包的类型，例如 Type 为 0x8000 时为 IP 协议包，Type 为 8060 时，后面为 ARP 协议包。以太网中多数数据帧使用的是 Ethernet II 帧格式。

Ethernet II 帧格式
![eth1](/docs/network/eth/eth1.png)

IEEE 802.3 帧格式
![eth2](/docs/network/eth/eth2.png)

对应数据链路层：首部(目的地址+源地址+类型|长度)+数据+尾部(FCS)

- 前导码：Ethernet II 是由 8 个 8‘b10101010 构成，IEEE802.3 由 7 个 8‘b10101010+1 个字节 SFD..
- 目的地址：目的设备的 MAC 物理地址。
- 源地址 ：发送设备的 MAC 物理地址。
- 类型(Ethernet II)：以太网首部后面所跟数据包的类型，例如 Type 为 0x8000 时为 IP 协议包，Type 为 8060 时，后面为 ARP 协议包。
- 长度(IEEE802.3)：当长度小于 1500 时，说明该帧为 IEEE802.3 帧格式，大于 1500 时，说明该帧为 Ethernet II 帧格式。
- 数据：数据长度最小为 46 字节，不足 46 字节时，填充至 46 字节。因为最小帧长度是 64 字节，所以，46+6+6+2+4=64。（不算前导码）
- FCS: 就是 CRC 校验值

## 以太网物理层

IEEE802.3 标准就给出了以太网的物理层结构，如下图所示红色框内所标注的
![eth3](/docs/network/eth/eth3.png)

我们可以看到物理大致可以分为： GMII 介质无关接口、 PCS 物理编码子层，PMA 物理介质连接层，PMD 物理介质相关层、MDI 接口 、MEDIUM 物理介质。

- 物理介质层  
  物理介质，我们最常见的就是我们的网线，这就是一种以太网传输的物理介质。常见的物理介质还有同轴电缆、光纤等。

- MDI 接口  
  MDI 就是连接 PHY 芯片和物理介质的接口，常见的是 RJ45 接口。百兆网时，MDI 四根线，两对差分信号，只用了 RJ45 的 1，2，3，6 线;千兆网时, MDI 一共 8 根线，四对差分信号， 用了 RJ45 的 8 根线。再说一下 RJ45 上的两个灯，绿灯长亮，表示链路完整。黄灯闪烁，表示有数据收发。

- PMD\PMA\PCS 层  
  不同规范下，每一层都不一样,具体查看对应规范。

- MII 接口  
  一般用于 MAC 和 PHY 之间的通信
