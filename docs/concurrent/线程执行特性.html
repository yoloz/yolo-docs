<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-concurrent/线程执行特性">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">线程执行特性 | Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.ylsite.tk/docs/concurrent/线程执行特性"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="线程执行特性 | Docs"><meta data-rh="true" name="description" content="转自Java 并发编程：核心理论"><meta data-rh="true" property="og:description" content="转自Java 并发编程：核心理论"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.ylsite.tk/docs/concurrent/线程执行特性"><link data-rh="true" rel="alternate" href="https://www.ylsite.tk/docs/concurrent/线程执行特性" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://www.ylsite.tk/docs/concurrent/线程执行特性" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Docs Atom Feed"><link rel="stylesheet" href="/assets/css/styles.6f328ed7.css">
<link rel="preload" href="/assets/js/runtime~main.d7ef0a43.js" as="script">
<link rel="preload" href="/assets/js/main.afc6c82a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="yolo-docs Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="yolo-docs Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yolo-docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/About">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yoloz/yolo-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/About">About</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/AI&amp;ML/machine learning">AI&amp;ML</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/bigdata/CDH使用">bigdata</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/concept/RESTful学习">concept</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/concurrent/JAVA管程模型">concurrent</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/JAVA管程模型">JAVA管程模型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/JAVA线程协作">JAVA线程协作</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/JAVA线程状态">JAVA线程状态</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/JAVA锁的使用">JAVA锁的使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/synchronized">synchronized</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/线程乱序问题">线程乱序问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/concurrent/线程执行特性">线程执行特性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concurrent/线程死锁问题">线程死锁问题</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/database/Join表的执行顺序">database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/devOps/su与sudo">devOps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/java/jgss常见问题">java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/linux/AIpine系统">linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/network/linux内核接收网络包">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/script/bash和bat">script</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tools/Proxmox(PVE)使用">tools</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/vue/大文件上传">vue</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">concurrent</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">线程执行特性</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>线程执行特性</h1></header><p>转自<a href="https://www.cnblogs.com/paddix/p/5374810.html" target="_blank" rel="noopener noreferrer">Java 并发编程：核心理论</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="共享性">共享性<a href="#共享性" class="hash-link" aria-label="共享性的直接链接" title="共享性的直接链接">​</a></h2><p>数据共享性是线程安全的主要原因之一。如果所有的数据只是在线程内有效，那就不存在线程安全性问题，这也是我们在编程的时候经常不需要考虑线程安全的主要原因之一。但是，在多线程编程中，数据共享是不可避免的。最典型的场景是数据库中的数据，为了保证数据的一致性，我们通常需要共享同一个数据库中数据，即使是在主从的情况下，访问的也同一份数据，主从只是为了访问的效率和数据安全，而对同一份数据做的副本。我们现在，通过一个简单的示例来演示多线程下共享数据导致的问题：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShareData</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShareData</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ShareData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Runnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">//进入的时候暂停1毫秒，增加并发问题出现的几率</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//主程序暂停3秒，以保证上面的程序执行完成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;count=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述代码的目的是对count进行加一操作，执行1000次，不过这里是通过10个线程来实现的，每个线程执行100次，正常情况下，应该输出1000。不过，如果你运行上面的程序，你会发现结果却不是这样。下面是某次的执行结果（每次运行的结果不一定相同，有时候也可能获取到正确的结果）：
<img loading="lazy" alt="thread1.png" src="/assets/images/thread1-72070f13c8ca840beffcadded4750c53.png" width="1228" height="140" class="img_ev3q">
可以看出，对共享变量操作，在多线程环境下很容易出现各种意想不到的的结果。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="互斥性">互斥性<a href="#互斥性" class="hash-link" aria-label="互斥性的直接链接" title="互斥性的直接链接">​</a></h2><p>资源互斥是指同时只允许一个访问者对其进行访问，具有唯一性和排它性。我们通常允许多个线程同时对数据进行读操作，但同一时间内只允许一个线程对数据进行写操作。所以我们通常将锁分为共享锁和排它锁，也叫做读锁和写锁。如果资源不具有互斥性，即使是共享资源，我们也不需要担心线程安全。例如，对于不可变的数据共享，所有线程都只能对其进行读操作，所以不用考虑线程安全问题。但是对共享数据的写操作，一般就需要保证互斥性，上述例子中就是因为没有保证互斥性才导致数据的修改产生问题。Java 中提供多种机制来保证互斥性，最简单的方式是使用Synchronized。现在我们在上面程序中加上Synchronized再执行：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ShareData</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ShareData</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ShareData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Runnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">//进入的时候暂停1毫秒，增加并发问题出现的几率</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">count </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//主程序暂停3秒，以保证上面的程序执行完成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;count=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * 增加 synchronized 关键字</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">synchronized</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在再执行上述代码，会发现无论执行多少次，返回的最终结果都是1000。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="原子性">原子性<a href="#原子性" class="hash-link" aria-label="原子性的直接链接" title="原子性的直接链接">​</a></h2><p>原子性就是指对数据的操作是一个独立的、不可分割的整体。换句话说，就是一次操作，是一个连续不可中断的过程，数据不会执行的一半的时候被其他线程所修改。保证原子性的最简单方式是操作系统指令，就是说如果一次操作对应一条操作系统指令，这样肯定可以能保证原子性。但是很多操作不能通过一条指令就完成。例如，对long类型的运算，很多系统就需要分成多条指令分别对高位和低位进行操作才能完成。还比如，我们经常使用的整数 i++ 的操作，其实需要分成三个步骤：（1）读取整数 i 的值；（2）对 i 进行加一操作；（3）将结果写回内存。这个过程在多线程下就可能出现如下现象：</p><p><img loading="lazy" alt="thread2.png" src="data:image/png;base64,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" width="612" height="178" class="img_ev3q"></p><p>这也是代码段一执行的结果为什么不正确的原因。对于这种组合操作，要保证原子性，最常见的方式是加锁，如Java中的Synchronized或Lock都可以实现，代码段二就是通过Synchronized实现的。除了锁以外，还有一种方式就是CAS（Compare And Swap），即修改数据之前先比较与之前读取到的值是否一致，如果一致，则进行修改，如果不一致则重新执行，这也是乐观锁的实现原理。不过CAS在某些场景下不一定有效，比如另一线程先修改了某个值，然后再改回原来值，这种情况下，CAS是无法判断的。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="可见性">可见性<a href="#可见性" class="hash-link" aria-label="可见性的直接链接" title="可见性的直接链接">​</a></h2><p>要理解可见性，需要先对JVM的内存模型有一定的了解，JVM的内存模型与操作系统类似，如图所示：</p><p><img loading="lazy" alt="thread3.png" src="data:image/png;base64,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" width="554" height="377" class="img_ev3q"></p><p>从这个图中我们可以看出，每个线程都有一个自己的工作内存（相当于CPU高级缓冲区，这么做的目的还是在于进一步缩小存储系统与CPU之间速度的差异，提高性能），对于共享变量，线程每次读取的是工作内存中共享变量的副本，写入的时候也直接修改工作内存中副本的值，然后在某个时间点上再将工作内存与主内存中的值进行同步。这样导致的问题是，如果线程1对某个变量进行了修改，线程2却有可能看不到线程1对共享变量所做的修改。通过下面这段程序我们可以演示一下不可见的问题：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">VisibilityTest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> ready</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ReaderThread</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ready</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ready</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">WriterThread</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">InterruptedException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printStackTrace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            number </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ready </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WriterThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ReaderThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从直观上理解，这段程序应该只会输出100，ready的值是不会打印出来的。实际上，如果多次执行上面代码的话，可能会出现多种不同的结果，下面是我运行出来的某两次的结果：
<img loading="lazy" alt="thread4.png" src="/assets/images/thread4-1b28295c830b569a3d083e1fcb7288b0.png" width="1196" height="160" class="img_ev3q">
<img loading="lazy" alt="thread5.png" src="/assets/images/thread5-30a930fac4b6dce211c3da9a0d4a6911.png" width="1206" height="158" class="img_ev3q">
当然，这个结果也只能说是有可能是可见性造成的，当写线程（WriterThread）设置ready=true后，读线程（ReaderThread）看不到修改后的结果，所以会打印false，对于第二个结果，也就是执行if (!ready)时还没有读取到写线程的结果，但执行System.out.println(ready)时读取到了写线程执行的结果。不过，这个结果也有可能是线程的交替执行所造成的。Java 中可通过Synchronized或Volatile来保证可见性，具体细节会在后续的文章中分析。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="有序性">有序性<a href="#有序性" class="hash-link" aria-label="有序性的直接链接" title="有序性的直接链接">​</a></h2><p>为了提高性能，编译器和处理器可能会对指令做重排序。重排序可以分为三种：</p><ul><li>编译器优化的重排序
编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。</li><li>指令级并行的重排序
现代处理器采用了指令级并行技术（Instruction-Level Parallelism， ILP）来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。</li><li>内存系统的重排序
由于处理器使用缓存和读/写缓冲区，这使得加载和存储操作看上去可能是在乱序执行。</li></ul><p>我们可以直接参考一下JSR 133 中对重排序问题的描述：</p><p><img loading="lazy" alt="thread6.png" src="/assets/images/thread6-d0952a3e85616268c44dc2a042e6bc21.png" width="527" height="125" class="img_ev3q"></p><p>（1）　　　　　　　　　　　　　　　　　　　　（2）</p><p>先看上图中的（1）源码部分，从源码来看，要么指令 1 先执行要么指令 3先执行。如果指令 1 先执行，r2不应该能看到指令 4 中写入的值。如果指令 3 先执行，r1不应该能看到指令 2 写的值。但是运行结果却可能出现r2==2，r1==1的情况，这就是“重排序”导致的结果。上图（2）即是一种可能出现的合法的编译结果，编译后，指令1和指令2的顺序可能就互换了。因此，才会出现r2==2，r1==1的结果。Java 中也可通过Synchronized或Volatile来保证顺序性。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yoloz/yolo-docs/tree/docusaurus/docs/concurrent/线程执行特性.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/concurrent/线程乱序问题"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">线程乱序问题</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/concurrent/线程死锁问题"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">线程死锁问题</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#共享性" class="table-of-contents__link toc-highlight">共享性</a></li><li><a href="#互斥性" class="table-of-contents__link toc-highlight">互斥性</a></li><li><a href="#原子性" class="table-of-contents__link toc-highlight">原子性</a></li><li><a href="#可见性" class="table-of-contents__link toc-highlight">可见性</a></li><li><a href="#有序性" class="table-of-contents__link toc-highlight">有序性</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 yolo. Built with ❤️ using Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d7ef0a43.js"></script>
<script src="/assets/js/main.afc6c82a.js"></script>
</body>
</html>