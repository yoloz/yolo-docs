<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-netty/了解netty写" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">了解netty写 | Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.ylsite.tk/docs/netty/了解netty写"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="了解netty写 | Docs"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.ylsite.tk/docs/netty/了解netty写"><link data-rh="true" rel="alternate" href="https://www.ylsite.tk/docs/netty/了解netty写" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://www.ylsite.tk/docs/netty/了解netty写" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Docs Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e72108b9.css">
<link rel="preload" href="/assets/js/runtime~main.105d8342.js" as="script">
<link rel="preload" href="/assets/js/main.f1b13794.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="yolo-docs Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="yolo-docs Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">yolo-docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/About">文档</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/yoloz/yolo-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/About">About</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/AI&amp;ML/machine learning">AI&amp;ML</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/bigdata/CDH使用">bigdata</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/concept/RESTful学习">concept</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/concurrent/JAVA的锁学习">concurrent</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/database/ES-SQL">database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/devOps/su与sudo">devOps</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/docker/dockerfile学习">docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/forend/HTML知识点">forend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/golang/defer及异常处理">golang</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/java/EventBus使用">java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/jvm/JNA中乱码和释放内存">jvm</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/linux/AIpine系统">linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/maven/maven-checkstyle-plugin">maven</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/netty/了解netty写">netty</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/netty/了解netty写">了解netty写</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/network/cksum问题">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/react/react-loadable代码分割">react</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/security/SSL双向认证实现">security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/shell/bash和bat">shell</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/spring/cache的使用">spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tools/CVEScannerV2">tools</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/vue/el-select下拉框验证">vue</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/window/nsis安装包制作">window</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">netty</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">了解netty写</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>了解netty写</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2><p>每个 ChannelSocket 的 Unsafe 都有一个绑定的 ChannelOutboundBuffer ， Netty 向站外输出数据的过程统一通过 ChannelOutboundBuffer 类进行封装，目的是为了提高网络的吞吐量，在外面调用 write 的时候，数据并没有写到 Socket，而是写到了 ChannelOutboundBuffer 这里，当调用 flush 的时候，才真正的向 Socket 写出。同时，本文也关注当缓冲区满了的时候，Netty 如何处理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="channeloutboundbuffer-介绍">ChannelOutboundBuffer 介绍<a href="#channeloutboundbuffer-介绍" class="hash-link" aria-label="ChannelOutboundBuffer 介绍的直接链接" title="ChannelOutboundBuffer 介绍的直接链接">​</a></h2><p>官方文档这么介绍的：</p><blockquote><p>(Transport implementors only) an internal data structure used by AbstractChannel to store its pending outbound write requests.
All methods must be called by a transport implementation from an I/O thread。
意思是，这个一个数据传输的实现者，一个内部的数据结构用于存储等待的出站写请求。所有的方法都必有由 IO 线程来调用。</p></blockquote><p>既然该类有一个内部的数据结构，我们就看看他的数据结构的样子，有以下几个属性：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> flushedEntry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 即将被消费的开始节点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> unflushedEntry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 被添加的开始节点，但没有准备好被消费。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token plain"> tailEntry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">// 最后一个节点</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从上面的属性可以看出，这他么就是个链表。不过，这个链表有 2 个头，在调用 addFlush 方法的时候会将 unflushedEntry 赋值给 flushedEntry。表示即将从这里开始刷新。具体如下图：</p><p><img loading="lazy" alt="netty1.png" src="data:image/png;base64,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" width="818" height="598" class="img_ev3q"></p><p>调用 addMessage 方法的时候，创建一个 Entry ，将这个 Entry 追加到 TailEntry 节点后面，调用 addFlush 的时候，将 unflushedEntry 的引用赋给 flushedEntry，然后将 unflushedEntry 置为 null。</p><p>当数据被写进 Socket 后，从 flushedEntry（current） 节点开始，循环将每个节点删除。</p><p>关于这 3 个方法，我们后面详细解释。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="addmessage-方法">addMessage 方法<a href="#addmessage-方法" class="hash-link" aria-label="addMessage 方法的直接链接" title="addMessage 方法的直接链接">​</a></h2><p>该方法 doc 文档：</p><blockquote><p>Add given message to this ChannelOutboundBuffer. The given ChannelPromise will be notified once the message was written.
将给定的消息添加到 ChannelOutboundBuffer，一旦消息被写入，就会通知 promise。</p></blockquote><p>代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Object</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ChannelPromise</span><span class="token plain"> promise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Entry</span><span class="token plain"> entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">total</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> promise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tailEntry </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        flushedEntry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tailEntry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Entry</span><span class="token plain"> tail </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tailEntry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tail</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tailEntry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unflushedEntry </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unflushedEntry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">incrementPendingOutboundBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pendingSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>说说方法步骤：</p><ol><li>根据 ByteBuf 相互属性和 promise 创建一个 Entry 节点。</li><li>将新的节点追加到 tailEntry 节点上。如果考虑之前的全部被清空了话，则新节点就是唯一节点，unflushedEntry 属性就是新的节点。可对照上面的图来看。</li><li>使用 CAS 将 totalPendingSize（总的数据大小） 属性增加 Entry 实例的大小（96 字节） + 真实数据的大小。</li></ol><p>主要这个 Entry 节点的创建有点意思：</p><p><img loading="lazy" alt="netty2.png" src="/assets/images/netty2-22392b0f747abdfe46ce3eaeb749566c.png" width="691" height="528" class="img_ev3q"></p><p>Netty 将在 ThreadLocalMap 中存储了一个 Stack （栈）对象，存储重复使用的 DefaultHandle 实例，该实例的 value 属性就是 Entry ，所以这个 Entry 也是重复使用的，每次用完所有参数置为 null，再返回到栈中，下次再用，从这个栈中弹出。重复利用。<strong>对象池的最佳实践。而且是保存再线程中，速度更快，不会有线程竞争。这个设计倒是可以学习以下。</strong></p><p>看完了 addMessage ，再看看 addFlush 方法。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="addflush-方法">addFlush 方法<a href="#addflush-方法" class="hash-link" aria-label="addFlush 方法的直接链接" title="addFlush 方法的直接链接">​</a></h2><p>当 addMessage 成功添加进 ChannelOutboundBuffer 后，就需要 flush 刷新到 Socket 中去。但是这个方法并不是做刷新到 Socket 的操作。而是将 unflushedEntry 的引用转移到 flushedEntry 引用中，表示即将刷新这个 flushedEntry，至于为什么这么做？
答：因为 Netty 提供了 promise，这个对象可以做取消操作，例如，不发送这个 ByteBuf 了，所以，在 write 之后，flush 之前需要告诉 promise 不能做取消操作了。</p><p>代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addFlush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Entry</span><span class="token plain"> entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> unflushedEntry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flushedEntry </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flushedEntry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            flushed </span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setUncancellable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pending </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cancel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">decrementPendingOutboundBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pending</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unflushedEntry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结合上面的图：</p><ol><li>首先拿到未刷新的头节点。</li><li>判 null 之后，将这个 unflushedEntry 赋值给 flushedEntry，而这里的判 null 是做什么呢？防止多次调用 flush 。
循环尝试设置这些节点，告诉他们不能做取消操作了，如果尝试失败了，就将这个节点取消，在调用 nioBuffers 方法的时候，这个节点会被忽略。同时将 totalPendingSize 相应的减小。</li><li>设置之后，promise 调用 cancel 方法就会返回 false。</li></ol><p>在调用完 outboundBuffer.addFlush() 方法后，Channel 会调用 flush0 方法做真正的刷新。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="flush0-方法">flush0 方法<a href="#flush0-方法" class="hash-link" aria-label="flush0 方法的直接链接" title="flush0 方法的直接链接">​</a></h2><p>flush0 的核心是调用 dowrite 方法并传入 outboundBuffer<code>try{dowrite(outboundBuffer)}catch(Throwable t){}</code></p><p>每种类型的 Channel 都实现都不一样。我们看的是 NioSocketChannel 的实现，方法很长，截取重要逻辑：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 拿到NIO Socket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">SocketChannel</span><span class="token plain"> ch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">javaChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 获取自旋的次数，默认16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> writeSpinCount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getWriteSpinCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 获取设置的每个 ByteBuf 的最大字节数，这个数字来自操作系统的 so_sndbuf 定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> maxBytesPerGatheringWrite </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">NioSocketChannelConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMaxBytesPerGatheringWrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 调用 ChannelOutboundBuffer 的 nioBuffers 方法获取 ByteBuffer 数组，从flushedEntry开始，循环获取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ByteBuffer</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> nioBuffers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nioBuffers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> maxBytesPerGatheringWrite</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ByteBuffer 的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> nioBufferCnt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">nioBufferCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 使用 NIO 写入 Socket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 调整最大字节数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">adjustMaxBytesPerGatheringWrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attemptedBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> localWrittenBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> maxBytesPerGatheringWrite</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 删除 ChannelOutboundBuffer 中的 Entry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">removeBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localWrittenBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 自旋减一，直到自旋小于0停止循环，当然如果 ChannelOutboundBuffer 空了，也会停止。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">--</span><span class="token plain">writeSpinCount</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 如果自旋16次还没有完成 flush，则创建一个任务放进mpsc 队列中执行。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">incompleteWrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writeSpinCount </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面的注释基本就是 flush 的逻辑。</p><p><strong>当然 flush0 方法在 NIO 的具体实现中，还加入了对注册事件的判断：</strong></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">flush0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">isFlushPending</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">flush0</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">boolean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isFlushPending</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">SelectionKey</span><span class="token plain"> selectionKey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">selectionKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> selectionKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isValid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selectionKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">interestOps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token class-name">SelectionKey</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OP_WRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里的判断是：如果注册了写事件，就暂时不写了，因为缓冲区到了水位线了，所以这次直接返回，等会再写。等到 EventLoop 触发写事件了，就会调用 <code>ch.unsafe().forceFlush()</code> 方法将数据刷新到 TCP 缓冲区。</p><p>这里有一个小知识点：<strong>NIO 的写事件大部分时候是不需要注册的，只有当 TCP 缓冲区达到水位线了，不能写入了，才需要注册写事件。当缓冲区有空间了，NIO 就会触发写事件。</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="缓冲区扩展思考">缓冲区扩展思考<a href="#缓冲区扩展思考" class="hash-link" aria-label="缓冲区扩展思考的直接链接" title="缓冲区扩展思考的直接链接">​</a></h2><p>从上面的逻辑上来看，不知道大家有没有发现一个问题：如果对方 Socket 接收很慢，ChannelOutboundBuffer 就会积累很多的数据。并且这个 ChannelOutboundBuffer 是没有大小限制的链表。可能会导致 OOM，Netty 已经考虑了这个问题，在　 addMessage 　方法的最后一行，incrementPendingOutboundBytes 方法，会判断　 totalPendingSize 　的大小是否超过了高水位阈值（默认 64 kb），如果超过，关闭写开关，调用 piepeline 的 fireChannelWritabilityChanged 方法可改变 flush 策略,后边如果仍然一直往队列放数据，缓存的消息的大小持续超过高水位线的时候，不会再 fireChannelWritabilityChanged</p><p><img loading="lazy" alt="netty3.png" src="/assets/images/netty3-3783399bd91062641ea18fb9ef74897c.png" width="708" height="1149" class="img_ev3q"></p><p>关于 channelWritabilityChanged API，Netty 这样解释：</p><blockquote><p>当 Channel 的可写状态发生改变时被调用。用户可以确保写操作不会完成的太快（以避免发生 OOM）或者可以在 Channel 变为再次可写时恢复写入。可以通过调用 Channel 的 isWritable 方法来检测 Channel 的可写性。与可写性相关的阈值可以通过 Channel.config().setWriteBufferHighWaterMark 和 Channel.config().setWriteBufferLowWaterMark 方法来设置，默认最小 32 kb，最大 64 kb。</p></blockquote><p>那么，上面时候恢复可写状态呢？remove 的时候，或者 addFlush 是丢弃了某个节点，会对 totalPendingSize 进行削减，削减之后进行判断。如果 totalPendingSize 小于最低水位了,就恢复写入。</p><p><img loading="lazy" alt="netty4.png" src="data:image/png;base64,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" width="851" height="183" class="img_ev3q"></p><p>也就是说，默认的情况下，ChannelOutboundBuffer 缓存区的大小最大是 64 kb，最小是 32 kb，哪里看出来的呢？</p><p><img loading="lazy" alt="netty5.png" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAx0AAABlCAMAAAAf3n6QAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAClUExURTIyMkAqKisqRHZCKsx4MU8qK8tlLSsrK5d2qjMzMypEgGU0KioqLEtTLysqWkBTlqm3xpdqbmVqqYFsMYdSQlFeqWqbuyo4bpdeV5d2QHV1nFWMwZJ0jSo/LkJ1rZpFKmVfMaiLY01MTZa0o3pzbrNTLIR1gitYlKihfbN1L2aLgFI/Ll9phoFcKjNHX4m2xTYqKmBtWmJJcT90unReUpWhfYFsMFm+OegAAA3ESURBVHja7F2LWuI6EJYWLAZp111AEBBUlFVx94h63v/RTjKXJL2AHAvd6s7/7VKSTKYF5+/MtB1yFAkEfzWuNw8dybcjEHYIOwQCYYdAIOwQCIQdAoGwQyAQdggEn5kdpz+OW/vc/0Z90/tm83bjeLfZPD7ocX06XD6JMdeWHfPb7fvJjnN7k77T0Wy71Xe3syOzP9XWGOo3ffOm57bRefusoV/vWviiTIvk25OOU4D9UfC9bSb0zdSoH/Kwa6M+O5/2Y6a1SQXqD3XfpMXyPB585/5ivAwGg2e9jce4ZYyflk+XI68jGD80aMLDP768grag0sjqo+zYhOl9Z7tAhh3v7C/RzIgvemB9aOQ9HlkbYiTGRM1Lf8jm9T30FVC/0aHf42B80UkJQxv1cRdrMUMwl/eqGaMmsFOQ5/FzQ6jh1k8Wj7va6LvazB99enz75pNjOUiAHS8P/wTjZ08+GK+EHXtix+mP2ajZ1H/g7m0XAh2KaKb3Ib3Mm81mx3Q3cUS3/ZP46Q/dP0uP+/I2Qpo2QX+WHTRuj4Pm59iRkXP788/t2vrZoK1hny/gLYxrs3SsOZ/49OR+sFx1Fqw6MJedgWuTPp7P+zFuyenW8uthsDaUJXke1y7qHXJoS38m7+A7j8sUO4KHxtKwIx4/RkwjlF8+JMCOvz4S3Qs7jGnr77GrbR7YgFZ5+sMwxfTr+Gduvmc6V8+P8X/uDE/jWXmWmDbDjLE3iQa0P2Pyx978nO9Iy2V8B57CNTvO8cQe8VYHQ8Y6Ydy8OHegvDjIWjmavDqL71p6PLHW7tqoz87n/Ri3lLiAKb5bD1XoyfN4MkzeI4fCkAl9iHUdo0xkFQE7zIsaDLpWXjNlKezYn+8wKUAITDBbtkrdhjGwbGftIOIHRd1mJxfpTAvYkQu0rBKy+hnN4/mb2DHL6veMWxueonTDbs8alhTmxbImSlsp9aPJJ8PzRbC6a7m0w7ZJn52vvDTHU6iG8d2i4cn3bVqU2m38+5vGz0Yq8SCX8ZKOkLJZObFDc+MaaQTy2u8sJbLaPzvS3uB01AH7NVeWms4aodn0/QCHTmStGfmUVe/CDjv//7FDmdO2iVw4bKEtJsE9HDcMSKzH6PdSeQv2g8nrCWqoeqvWquWsHdusz+Xpbj9+xJT0dI8Ox1iex+OL14vOe38yjKyWqbQjD2THQEsFwA6QN8wQduyVHcZQs+yI5rPpMUVYWd+Rv8pl2ZGVT0VqO7DDzf9/7MCke9LKJuV4aWlI48PImXB8UZSUAzs0lRLDhbVNOyJusz6e7yflygVWlMTrcIzkeVxHbqmILu87IjTxd8mB7FCDLuUdKG8ueQ0o0hLshR0mj8ixY3o8D/G66+nIWGMXw5758YarSziek7eRWrOzEzvs/PfY0U2F1eZEnrRdWkFbSkeGbJnehapsUh6SD9LBl9aTTLQbmniXoLBt9RUl5R7fsFuHYyzP4xBo9bb/xSC7fpccyA4Ip17S8px3NDti/aWzcoyMyBahTVeHwPzMpabwvoUjx94E75IV8gLHM/JOX7fwmhWPu8gK57t5Ueq4HDtof5G9SYG3Ndr4htIIjJfgQi7e3Igv+C5HNimn/gQ3fZNAt513obbTx0k57Q9aLrSi9OXMyvO4IZZqh1uYgfc7zO2LweChEW27L2LGg3FOniKreXMm1r8H3yH4iuiK7xB2CAoxvRdyCDtKAeIieuDkI+Nl5QX1ZodAIOwQdggEwg6BQNghEFTPDql+qjmkCqqG7Pji1U8wrsyjKDwvgS33s1xVVVB8my9bzSRVULWMrL549ZMdtw9QacsN1g3X702qoApK8bNS2WomqYKqjh1S/cTzh6wEH0JhQrh+tNWqqqBeuPKJq5lsYCVVUBWyQ6qf7HxUopwDSfUj6SqqgorHycA8nO6qmdh1SBVUpb5Dqp8iegoR0xB+iF1nCJOO10+eqJoqqBie09Umn69mkiqoP8GOtDf4y6qfXPKNYVFCmXw2Ka+qCgoiJf2yQzWTVEEdlh1S/ZRLyoEQup1JyiurgoLoSLNjh2omqYI6LDuk+omS9p7tP4coqef1EzuqqoJ6cSf/XXyHVEEdKCuX6icv+YZzPN6d0AizSXllVVBwu4NYsZUdUgV1aN8h+MqQKihhh6AYUgUl7Pggdq1Wkiqov5MdAoGwQ9ghEAg7BAJhh0Ag7BAIhB0CgbBDIBB2CATCDoFA2CEQCDsEAmGHsEMgEHYIBMIOgUDYIRAIOwQCYYdAIOwQCIQdAoGwQyAQdggEwg4D+xsldmWBj/6G977WfMoiGPxs7HQA6jf+lj9v94vxSEzr72WH9+uI29lx2DWf0Agvr/LsSJtnMEj9DG1kfpn2KbUtMm5fb7G5x7919+VN+C47yq49JfiU7HgPh13zCe3Xt+Ji8wwGT/q/L6ZuWqltGnm9xexQN2+NYLADO8quPSWoITt4LSX3G+izH7QAAf86dPHaTRWt+URWPNL/cNEj/Wq6Ls1PlsO7MfgMww4jDNulcSJZdqAc67F6Tb+WyOpjOfU2CNViELKcPQ7NjhRryq49JaglO3DtJ8cO3Z66NZmiDWs3VbXm0/LKmLA2xUttswqskU74dPIeX8F/9B1Plh1o7Tct3rIc63F6tfzY0CGtj+XUWzK6fNVKWY6PYzxKuaqya08Jauo7YFEOz3dEqTWgNq3dVNGaT8ufweCtMdbWqS0zzrMDurR7gLzjKtroO1iO9Vi9uJNGVp+Ti9/uQCnJ8XGMz1JxXOm1pzLrdwg+Ezvyv7dbzZpPy5/qahwadlylgy2yZgVWdRNiZPWzsYkdLMezrV4YcOzIyV2Bl3ByfBzjb6lkpOzaU4LaskMb7PvsuC26Zhsdes0nddN/Wp4Nwk3siMlGgRXgQ7b4Dm826w0Go7zv8OSWsBk/WTnLjtHSp0fZtafEd9SWHbSO7PSe2DE/jnKRVdEqEBWs+aRublrxzU0BOy7pwu6VY4fp0m31uyArJznHDtRrrvfGIJ/WZ/eC7BhZOceO1IXesmtPCWqalfMC5TpXpjWXjv21lorXbqpqzSdjkXBt6JJZwNeWzLsr6rhy9zt0BHSzfsuzgxMT0mP1LnUctTLyaX1Zdlg5jx06Q3+ySXm5tacE9fUdAoGwQ9ghEAg7BII9sEMgEHZsZseJfEUCYYewQyAQdgg+NY6OTtIInh9/LR7h7a9F66QYR0dfgR31q15Sb3LnoUbIG34xO369NjL8wPlUXUfYVE0XDMI/z45PUL2EOyhdvcR398yNQXP3D54k6dsduzbqs/NpP/Z+Iqtrmwe04Oks6OZxfHBrkqtZKXv8MK7MozA8L4Et91f1OaKjQnZYSmxhB9KDq+scP4rrlJZwl/jPsuMTVC/hu9LVS9RvdOj3OOgeV/faqI+7WIsZgrm817Z5dBF2CvI8bh5A6Q/zH7Ts8dtxegAMLDdYN1x/NZ8DXcfqFc3/12KhnQb5jmC1WDxrdmCnbixeoe/xhDzLEbqOzk7sQOM5LDtS1UvHrdxj6/WvXiL9ZauXuB/+4uosWHVgrrUq2yZ9PJ/3Y87RTreWXw+DtTF5kudxfeovNKqyxw9KQQgfgmFCuP5qPgew48i4iGD1eHLdMN4C2RGs5oYMLeoE32H69BDHXT47MtV0VK3HdhrRA6fXmyu498IOql7iJxlhV3Pr3OpfvYSHU7p6KWUq6iy+a+nxxFqJa6M+O5/3Y6wxcYFGfLceqtCT5/FkmBQZVdnjt+PUz08Qe/2VfA7yHYYZFDkZXgA7IKiiyMrQwYwji+YcWnnVddlqOvYgZKdsgYdmBz9jGwJtp/et7q13A7721UvwaHr56iXuR1NJhueLYHXXcmmHbZM+O195aYKnUA3ju0XDk+/btKLQqEpXX13YNAT6MQOZdLz+Sj4HJ+W/Xk/QVZgoithh2GI8CXYSOww8dqQiK78igp4VZzuF86I2hYNHVnAUULykQ6zTUedp1vo3dOyoefUSMad09RL1g6noCWqoeqvWquWsBNusz+W3bj9+pJH0dI8OY1iex+OL14uiJ9/LHr9LvvHoEsrks0n5oT+HZcfz9fMjBlBZ30GdyI50Zu6xI1dNhxev2E75ZFkNO7BgynCzM5uHo47LimtevUS+o2z1EvfziTcxNrS2aUfEbdbnkl+XzHpGSMmvDmNInsd15Fb46HvZ488m5XAsup1Jyg/+OZgdwer5FeOoFbOD8w7qdFHVcyufdxRV05lqPbZTNpFq2MGx3Om/s9n09t6da2pfvYQdZauXuF/p3nOtJ5no0/jEu3SDbauvKJn17BW7dRjD8jwOAUoPz0N+XVnZ48ekvWf7zyFK6nn91XwOe7sDDN4EUa/MDgijrjGyesVLWK90/Sp/zaqwmq7rcg4/72h2Ds4OLpuaNzv6qLz7DXWvXgL9pauXbH+Cm75JPNte7SC2nT5OZml/0HIhCaUvZ1aex41BKtQ7937tpezx2+QbzvF4d0IjzCblh/4cxfc7doV/RTdTTWer9Wy5H1+z0vufyZMku9w1/1ToNr9G6W32c3ycHR+4FXe9+XsUdhjvV3wzvu7Q6eWXIEfB5zgq4Tl2B90r3/w9CjvQ/X/4OSuIJ+jBi4+Ml5Uvi133V/fP8QHU4jkrgaDO2MYOwX/t0zENAAAAwjAv+BfJhQpaCUvGt0gA7gB3gDvAHeAOcAe4A9wB7gB3TAEU6zDvUdaqSAAAAABJRU5ErkJggg==" width="797" height="101" class="img_ev3q"></p><p>当然了，可以在 option 选项中进行修改，API 文档也说过了。</p><p>当不能写的时候，就会调用 ChannelWritabilityChanged 方法，用户可以在代码中，让写操作进行的慢一点。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>Netty 的 write 的操作不会立即写入，而是存储在了 ChannelOutboundBuffer 缓冲区里，这个缓冲区内部是 Entry 节点组成的链表结构，通过 addMessage 方法添加进链表，通过 addFlush 方法表示可以开始写入了，最后通过 SocketChannel 的 flush0 方法真正的写入到 JDK 的 Socket 中。同时需要注意如果 TCP 缓冲区到达一个水位线了，不能写入 TCP 缓冲区了，就需要晚点写入，这里的方法判断是 isFlushPending()</p><p>其中，有一个需要注意的点就是，如果对方接收数据较慢，可能导致缓冲区存在大量的数据无法释放，导致 OOM，Netty 通过一个 isWritable 开关尝试解决此问题，但用户需要重写 ChannelWritabilityChanged 方法，因为一旦超过默认的高水位阈值，Netty 就会调用 ChannelWritabilityChanged 方法，执行完毕后，继续进行 flush。用户可以在该方法中尝试慢一点的操作。等到缓冲区的数据小于低水位的值时，开关就关闭了，就不会调用 ChannelWritabilityChanged 方法。因此，合理设置这两个数值也挺重要的。</p><p>转自<a href="https://www.cnblogs.com/stateis0/p/9062155.html" target="_blank" rel="noopener noreferrer">Netty 出站缓冲区 ChannelOutboundBuffer 源码解析（isWritable 属性的重要性）</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/yoloz/yolo-docs/tree/docusaurus/docs/netty/了解netty写.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/maven/搭建maven仓库"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">搭建maven仓库</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/network/cksum问题"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">cksum问题</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#channeloutboundbuffer-介绍" class="table-of-contents__link toc-highlight">ChannelOutboundBuffer 介绍</a></li><li><a href="#addmessage-方法" class="table-of-contents__link toc-highlight">addMessage 方法</a></li><li><a href="#addflush-方法" class="table-of-contents__link toc-highlight">addFlush 方法</a></li><li><a href="#flush0-方法" class="table-of-contents__link toc-highlight">flush0 方法</a></li><li><a href="#缓冲区扩展思考" class="table-of-contents__link toc-highlight">缓冲区扩展思考</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 yolo. Built with ❤️ using Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.105d8342.js"></script>
<script src="/assets/js/main.f1b13794.js"></script>
</body>
</html>